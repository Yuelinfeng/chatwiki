import{C as ze}from"./cu-scroll-2Rw1X78x.js";import{_ as pe,e as q,c as fe,M as X,bu as Ne,bb as ue,S as te,B as Ue}from"../../index-GVMBwoSB.js";import{$ as ve,a0 as he,r as w,A as O,L as s,M as i,j as e,Q as t,V as n,U as De,u as C,a8 as _,P as I,F as D,a1 as Oe,a2 as Te,Y as L,a9 as oe,X as p,v as Re,B as Ve,a7 as Be,a3 as Pe,a4 as Ae}from"./vue-chunks-CX0PHdkT.js";import{a as Ee}from"./dayjs-DItM2b4N.js";import{i as ae,j as je,k as Ye,l as Qe}from"./index-VltaZJWM.js";import{U as He}from"./upload-input-D9QK-JM0.js";import{t as ce}from"./validate-8MtiUsxW.js";import{F as se,_ as ye}from"./index-BL197tQK.js";import"./index-CKa5RZod.js";import{I as ge}from"./Input--aGP1T3B.js";import"./index-B1DEEKq7.js";import{R as Je,_ as Xe}from"./RadioButton-BQ62eZio.js";import{M as Ge}from"./model-select-8zoAlKSE.js";import{_ as Ke,M as We}from"./index-BD0PNgcQ.js";import"./index-BD0dTjKV.js";import{D as Ze}from"./dropdown-DGCGRXRs.js";import{S as et}from"./index-D_8JGheY.js";import{_ as tt}from"./index-DrP-z-Bt.js";import{P as ot}from"./PlusOutlined-sorM8mvn.js";import{S as at}from"./SearchOutlined-DS22VXIZ.js";import{C as me}from"./ClockCircleFilled-C8-GLcsm.js";import{M as st}from"./MoreOutlined-Bb7qc7Bp.js";import{_ as nt}from"./index-LfbI52ck.js";import{_ as lt}from"./index-3QeQOpaK.js";import{a as it}from"./index-C_4PDLyK.js";import{_ as _t}from"./TextArea-DeS198JN.js";import{S as rt,_ as dt}from"./index-Dh5rPAT7.js";import"./pull-up.esm-JZ91zQ8P.js";import"./axios-Cm0UX6qg.js";import"./qs-D52wVmk8.js";import"./crypto-js-ZYyBUTQg.js";import"./InboxOutlined-BCw2-q4t.js";import"./index-DTami1oY.js";import"./partition-B-kgZtUf.js";import"./colors-D_W7fn18.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-DduaVHe6.js";import"./inputProps-BUZdA0Zp.js";import"./CheckOutlined-DWxGZyjB.js";import"./useRefs-DaOtXq3f.js";import"./collapseMotion-7Vnsd4b5.js";import"./FormItemContext-2KmsKwBN.js";import"./isPlainObject-BNcE28c5.js";import"./responsiveObserve-CXBgjl43.js";import"./QuestionCircleOutlined-BtZ-HKyh.js";import"./index-DaXP6XK8.js";import"./Search-DaeGz4LJ.js";import"./statusUtils-BFiV3r53.js";import"./index-CHuKnngI.js";import"./shallowequal-BtoafKsn.js";import"./slide-9COri5Ta.js";import"./index-CZ0E7pKU.js";import"./Dropdown-1ablIDCT.js";import"./RightOutlined-Ctsl4k5I.js";import"./move-DRhCXx5X.js";import"./index-r28ZkMx3.js";import"./index-CDXjbs9D.js";import"./useMaxLevel-CvIB4LA8.js";import"./index-QZr53X2a.js";import"./css-grC2A7nw.js";import"./LeftOutlined-DoeBxBmI.js";import"./DownOutlined-CsDw0PzO.js";import"./index-CWkJaLLt.js";import"./isMobile-D_4OiXLP.js";const ut={class:"form-box"},ct={class:"upload-document-type-box"},mt=["onClick"],pt={class:"right-block"},ft={class:"title-block"},vt={class:"title-text"},ht={class:"desc"},yt={__name:"add-custom-document",props:{libraryInfo:{type:Object,default:()=>{}}},emits:["ok"],setup(M,{expose:G,emit:T}){const j=ve(),k=he(),d=se.useForm,$=w(!1),z=w("添加自定义文档"),F=M,f=O({library_id:k.query.id,doc_type:3,file_name:"",is_qa_doc:0,qa_index_type:1}),Y=w([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),N=b=>{f.qa_index_type=b},h=O({file_name:[{message:"请输入昵称",required:!0}]}),{resetFields:R,validate:K,validateInfos:U}=d(f,h),Q=()=>{$.value=!0,R(),f.file_name="",f.is_qa_doc=0,f.qa_index_type=1,F.libraryInfo.type==2&&(f.is_qa_doc=1)},V=w(!1),B=()=>{K().then(()=>{let b={...oe(f)};V.value=!0,ae(b).then(x=>{q.success(`${z.value}成功`),$.value=!1,j.push("/library/preview?id="+x.data.file_ids[0])}).finally(()=>{V.value=!1})})};return G({add:Q}),(b,x)=>{const W=ge,P=ye,ne=Je,r=Xe,H=fe,J=se,Z=X;return s(),i("div",null,[e(Z,{open:$.value,"onUpdate:open":x[2]||(x[2]=v=>$.value=v),title:z.value,onOk:B,width:"472px",confirmLoading:V.value},{default:t(()=>[n("div",ut,[e(J,{layout:"vertical"},{default:t(()=>[e(P,De({label:"文档名称"},C(U).file_name),{default:t(()=>[e(W,{type:"text",placeholder:"请输入文档名称",value:f.file_name,"onUpdate:value":x[0]||(x[0]=v=>f.file_name=v)},null,8,["value"])]),_:1},16),_("",!0),f.is_qa_doc==1?(s(),I(P,{key:1,label:"索引方式",required:""},{default:t(()=>[n("div",ct,[(s(!0),i(D,null,Oe(Y.value,v=>(s(),i("div",{class:Te(["type-item",{active:f.qa_index_type==v.value}]),key:v.value,onClick:m=>N(v.value)},[n("div",pt,[n("div",ft,[e(H,{name:f.qa_index_type==v.value?v.iconNameActive:v.iconName},null,8,["name"]),n("div",vt,L(v.title),1)]),n("div",ht,L(v.desc),1)]),f.qa_index_type==v.value?(s(),I(H,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):_("",!0)],10,mt))),128))])]),_:1})):_("",!0)]),_:1})])]),_:1},8,["open","title","confirmLoading"])])}}},gt=pe(yt,[["__scopeId","data-v-80f3643f"]]),S=M=>(Pe("data-v-e724827f"),M=M(),Ae(),M),kt={class:"details-library-page"},bt={class:"list-tools"},xt={class:"tools-items"},Ct={class:"tool-item"},wt={class:"dropdown-btn-menu"},Lt=S(()=>n("div",{class:"title"},"本地文档",-1)),qt={key:0,class:"desc"},It={key:1,class:"desc"},St={class:"dropdown-btn-menu"},Ft=S(()=>n("div",{class:"title"},"在线数据",-1)),Mt=S(()=>n("div",{class:"desc"},"获取在线网页内容",-1)),$t={class:"dropdown-btn-menu"},zt=S(()=>n("div",{class:"title"},"自定义文档",-1)),Nt=S(()=>n("div",{class:"desc"},"自定义一个空文档，手动添加内容",-1)),Ut=S(()=>n("span",null,"添加内容",-1)),Dt={class:"tool-item"},Ot=S(()=>n("span",null,"嵌入模型：",-1)),Tt={class:"tool-item"},Rt={class:"list-content"},Vt={key:0,class:"doc-name-td"},Bt=["onClick"],Pt={key:0},At={key:1},Et={key:0,class:"url-remark"},jt={key:0,class:"status-tag status-queuing"},Yt={key:1,class:"status-tag status-learning"},Qt={key:2,class:"status-tag status-complete"},Ht={class:"status-tag status-error"},Jt={class:"status-tag status-complete"},Xt=["onClick"],Gt={key:5,class:"status-tag status-complete"},Kt={key:6,class:"status-tag status-learning"},Wt={class:"status-tag status-error"},Zt={key:0,class:"status-tag status-queuing"},eo={key:1,class:"status-tag status-learning"},to={key:2,class:"status-tag status-complete"},oo={key:3,class:"status-tag status-error"},ao={key:0},so={key:1},no={key:0},lo={key:1},io=["onClick"],_o=S(()=>n("span",null,"删除",-1)),ro={class:"upload-file-box"},uo={__name:"knowledge-document",setup(M){const G=he(),T=ve(),j=G.query,k=w({library_intro:"",library_name:"",use_model:"",is_offline:null,type:0}),d=O({use_model:"",model_config_id:""}),$=(o,a)=>{let u=a.modelName,g=a.modelId;N.value.length>0?X.confirm({title:`确定切换模型为${u}吗？`,content:"切换后，所有学习文档将自动重新学习。",onOk(){d.use_model=u,d.model_config_id=g,z()},onCancel(){}}):(d.use_model=u,d.model_config_id=g,z())},z=(o=!0)=>{Ye({...oe(k.value),use_model:d.use_model,model_config_id:d.model_config_id}).then(()=>{k.value.use_model=d.use_model,k.value.model_config_id=d.model_config_id,o&&q.success("保存成功")})},F=w([]),f=o=>{F.value=o,Y()},Y=()=>{if(!k.value.id){setTimeout(()=>{Y()},100);return}if(F.value.length>0&&!k.value.use_model){let o=null,a=null;for(let u of F.value)if(u.model_define==="chatwiki"){o=u;for(let g of o.children)if(g.name==="text-embedding-v2"){a=g;break}break}o||(o=F.value[0],a=o.children[0]),o&&(d.use_model=a.name,d.model_config_id=a.model_config_id,z(!1))}},N=w([]),h=O({library_id:j.id,file_name:void 0,page:1,size:10,total:0}),R=w([{title:"文档名称",dataIndex:"file_name",key:"file_name",width:450},{title:"状态",dataIndex:"status",key:"status",width:160},{title:"知识图谱",dataIndex:"graph_status",key:"graph_status",width:160},{title:"文档格式",dataIndex:"file_ext",key:"file_ext",width:100},{title:"文档大小",dataIndex:"file_size_str",key:"file_size",width:100},{title:"分段",dataIndex:"paragraph_count",key:"paragraph_count",width:120},{title:"更新时间",dataIndex:"update_time",key:"update_time",width:150},{title:"操作",dataIndex:"action",key:"action",width:100}]),K=o=>{h.page=o.current,h.size=o.pageSize,b()},U=()=>{h.page=1,b()};let Q=!1;const V=({id:o})=>{N.value.length==1&&(Q=!0),Qe({id:o}).then(()=>{Q&&h.page>1&&h.page--,b(),q.success("删除成功")})},B=o=>{if(o.status=="4")return T.push({path:"/library/document-segmentation",query:{document_id:o.id}});if(o.status=="3")return q.error("学习失败,不可预览");if(o.status=="0")return q.error("转换中,稍候可预览");if(o.status=="6")return q.error("获取中,不可预览");if(o.status=="7")return q.error("获取失败,不可预览");T.push({name:"libraryPreview",query:{id:o.id}})},b=()=>{je(oe(h)).then(o=>{let a=o.data.info;!d.use_model&&d.use_model!=a.use_model&&(d.use_model=a.use_model,d.model_config_id=a.model_config_id),k.value={...a},a.graph_switch=="0"&&(R.value=R.value.filter(y=>y.key!="graph_status"));let u=o.data.list||[];h.total=o.data.total;let g=!1;N.value=u.map(y=>(["1","6","0","5","4"].includes(y.status)&&(g=!0),y.file_size_str=Ne(y.file_size),y.update_time=Ee(y.update_time*1e3).format("YYYY-MM-DD HH:mm"),y)),g&&W(),!g&&clearInterval(x.value)})},x=w(null),W=()=>{clearInterval(x.value),x.value=setInterval(()=>{b()},1e3*5)},P=w(null),ne=o=>{if(F.value.length==0){X.confirm({title:"请先到模型管理中添加嵌入模型？",content:"知识库学习需要使用到嵌入模型，请在系统管理-模型管理中添加。推荐使用通义千问、openai或者火山引擎的嵌入模型。",okText:"去添加",onOk(){T.push({path:"/user/model"})}});return}let{key:a}=o;a==1&&ke(),a==2&&H(),a==3&&P.value.add()},r=O({open:!1,urls:"",library_id:j.id,doc_auto_renew_frequency:1,confirmLoading:!1,rules:{urls:[{message:"请输入网页地址",required:!0},{validator:(o,a)=>ce(a)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve()}]}}),H=()=>{r.open=!0,r.confirmLoading=!1,r.urls="",r.doc_auto_renew_frequency=1},J=w(null),Z=()=>{J.value.validate().then(()=>{r.confirmLoading=!0,ae({library_id:r.library_id,urls:JSON.stringify(ce(r.urls)),doc_auto_renew_frequency:r.doc_auto_renew_frequency,doc_type:2}).then(()=>{r.open=!1,r.confirmLoading=!1,U()})}).catch(()=>{r.confirmLoading=!1})},v=()=>{r.open=!1},m=O({open:!1,fileList:[],confirmLoading:!1}),ke=()=>{m.fileList=[],m.open=!0},be=()=>{m.fileList=[]},xe=o=>{m.fileList=o},Ce=()=>{if(m.fileList.length==0){q.error("请选择文件");return}m.confirmLoading=!0;let o=new FormData;o.append("library_id",h.library_id);let a=!1;m.fileList.forEach(u=>{(u.name.includes(".xlsx")||u.name.includes(".csv"))&&(a=!0),o.append("library_files",u)}),ae(o).then(u=>{b(),m.open=!1,m.fileList=[],m.confirmLoading=!1,a&&T.push("/library/document-segmentation?document_id="+u.data.file_ids[0])}).catch(()=>{m.confirmLoading=!1})};return Re(()=>{b()}),Ve(()=>{x.value&&clearInterval(x.value)}),(o,a)=>{const u=fe,g=nt,y=Ke,le=We,we=Ue,ie=Ze,Le=ge,A=et,_e=lt,qe=tt,Ie=it,Se=ze,re=X,Fe=_t,de=ye,E=rt,Me=dt,$e=se;return s(),i("div",kt,[e(Se,{scrollbar:!1},{default:t(()=>[n("div",bt,[n("div",xt,[n("div",Ct,[e(ie,{trigger:["click"],overlayClassName:"add-dropdown-btn"},{overlay:t(()=>[e(le,{onClick:ne},{default:t(()=>[(s(),I(y,{key:1},{default:t(()=>[n("div",wt,[e(g,{class:"title-block",gap:4},{default:t(()=>[e(u,{name:"doc-icon"}),Lt]),_:1}),k.value.type==2?(s(),i("div",qt,"上传本地 docx/csv/xlsx 等格式文件")):(s(),i("div",It,"上传本地 pdf/docx/ofd/txt/md/xlsx/csv/html 等格式文件"))])]),_:1})),k.value.type!=2?(s(),I(y,{key:2},{default:t(()=>[n("div",St,[e(g,{class:"title-block",gap:4},{default:t(()=>[e(u,{name:"link-icon"}),Ft]),_:1}),Mt])]),_:1})):_("",!0),(s(),I(y,{key:3},{default:t(()=>[n("div",$t,[e(g,{class:"title-block",gap:4},{default:t(()=>[e(u,{name:"cu-doc-icon"}),zt]),_:1}),Nt])]),_:1}))]),_:1})]),default:t(()=>[e(we,{type:"primary"},{icon:t(()=>[e(C(ot))]),default:t(()=>[Ut]),_:1})]),_:1})]),n("div",Dt,[Ot,e(Ge,{modelType:"TEXT EMBEDDING",isOffline:!1,modeName:d.use_model,modeId:d.model_config_id,style:{width:"300px"},onChange:$,onLoaded:f},null,8,["modeName","modeId"])])]),n("div",null,[n("div",Tt,[e(Le,{style:{width:"282px"},value:h.file_name,"onUpdate:value":a[0]||(a[0]=c=>h.file_name=c),placeholder:"请输入文档名称搜索",onChange:U},{suffix:t(()=>[e(C(at),{onClick:U,style:{color:"rgba(0, 0, 0, 0.25)"}})]),_:1},8,["value"])])])]),n("div",Rt,[e(Ie,{columns:R.value,"data-source":N.value,pagination:{current:h.page,total:h.total,pageSize:h.size,showQuickJumper:!0,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"]},onChange:K},{bodyCell:t(({column:c,record:l})=>[c.key==="file_name"?(s(),i("div",Vt,[n("a",{onClick:ee=>B(l)},[["5","6","7"].includes(l.status)?(s(),i("span",Pt,L(l.doc_url),1)):(s(),i("span",At,L(l.file_name),1))],8,Bt),l.doc_type==2&&l.remark?(s(),i("div",Et," 备注："+L(l.remark),1)):_("",!0)])):_("",!0),c.key==="status"?(s(),i(D,{key:1},[l.status==0?(s(),i("span",jt,[e(A,{size:"small"}),p(" 转换中")])):_("",!0),l.status==1?(s(),i("span",Yt,[e(A,{size:"small"}),p(" 学习中")])):_("",!0),l.status==2?(s(),i("span",Qt,[e(C(ue)),p(" 学习完成")])):_("",!0),l.status==3?(s(),I(_e,{key:3,placement:"top"},{title:t(()=>[n("span",null,L(l.errmsg),1)]),default:t(()=>[n("span",Ht,[e(C(te)),p(" 学习失败")])]),_:2},1024)):_("",!0),l.status==4?(s(),i(D,{key:4},[n("span",Jt,[e(C(me)),p(" 待学习")]),n("a",{class:"ml8",onClick:ee=>B(l)},"学习",8,Xt)],64)):_("",!0),l.status==5?(s(),i("span",Gt,[e(C(me)),p(" 待获取")])):_("",!0),l.status==6?(s(),i("span",Kt,[e(A,{size:"small"}),p(" 获取中")])):_("",!0),l.status==7?(s(),I(_e,{key:7,placement:"top"},{title:t(()=>[n("span",null,L(l.errmsg),1)]),default:t(()=>[n("span",Wt,[e(C(te)),p(" 获取失败")])]),_:2},1024)):_("",!0)],64)):_("",!0),c.key==="graph_status"?(s(),i(D,{key:2},[l.graph_status==0?(s(),i("span",Zt,[e(A,{size:"small"}),p(" 未开始")])):_("",!0),l.graph_status==1?(s(),i("span",eo,[e(A,{size:"small"}),p(" 排队中")])):_("",!0),l.graph_status==2?(s(),i("span",to,[e(C(ue)),p(" 学习完成")])):_("",!0),l.graph_status==3?(s(),i("span",oo,[e(C(te)),p(" 学习失败")])):_("",!0)],64)):_("",!0),c.key==="file_size"?(s(),i(D,{key:3},[l.doc_type==3?(s(),i("span",ao,"-")):(s(),i("span",so,L(l.file_size_str),1))],64)):_("",!0),c.key==="paragraph_count"?(s(),i(D,{key:4},[l.status==0||l.status==1?(s(),i("span",no,"-")):(s(),i("span",lo,L(l.paragraph_count),1))],64)):_("",!0),c.key==="action"?(s(),I(ie,{key:5},{overlay:t(()=>[e(le,null,{default:t(()=>[e(y,{disabled:l.status==6||l.status==7||l.status==0},{default:t(()=>[n("div",{onClick:ee=>B(l)},"预览",8,io)]),_:2},1032,["disabled"]),e(y,null,{default:t(()=>[e(qe,{title:"确定要删除吗?",onConfirm:ee=>V(l)},{default:t(()=>[_o]),_:2},1032,["onConfirm"])]),_:2},1024)]),_:2},1024)]),default:t(()=>[n("div",{class:"table-btn",onClick:a[1]||(a[1]=Be(()=>{},["prevent"]))},[e(C(st))])]),_:2},1024)):_("",!0)]),_:1},8,["columns","data-source","pagination"])])]),_:1}),e(re,{open:m.open,"onUpdate:open":a[3]||(a[3]=c=>m.open=c),"confirm-loading":m.confirmLoading,maskClosable:!1,title:"上传文档",onOk:Ce,onCancel:be},{default:t(()=>[n("div",ro,[e(He,{type:k.value.type,value:m.fileList,"onUpdate:value":a[2]||(a[2]=c=>m.fileList=c),onChange:xe},null,8,["type","value"])])]),_:1},8,["open","confirm-loading"]),e(re,{open:r.open,"onUpdate:open":a[6]||(a[6]=c=>r.open=c),"confirm-loading":r.confirmLoading,maskClosable:!1,title:"添加在线数据",width:"746px",onOk:Z,onCancel:v},{default:t(()=>[e($e,{class:"url-add-form",layout:"vertical",ref_key:"urlFormRef",ref:J,model:r,rules:r.rules},{default:t(()=>[e(de,{name:"urls",label:"网页链接"},{default:t(()=>[e(Fe,{style:{height:"120px"},value:r.urls,"onUpdate:value":a[4]||(a[4]=c=>r.urls=c),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1}),e(de,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:t(()=>[e(Me,{value:r.doc_auto_renew_frequency,"onUpdate:value":a[5]||(a[5]=c=>r.doc_auto_renew_frequency=c),style:{width:"100%"}},{default:t(()=>[e(E,{value:1},{default:t(()=>[p("不自动更新")]),_:1}),e(E,{value:2},{default:t(()=>[p("每天")]),_:1}),e(E,{value:3},{default:t(()=>[p("每3天")]),_:1}),e(E,{value:4},{default:t(()=>[p("每7天")]),_:1}),e(E,{value:5},{default:t(()=>[p("每30天")]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["open","confirm-loading"]),e(gt,{libraryInfo:k.value,onOk:U,ref_key:"addCustomDocumentRef",ref:P},null,8,["libraryInfo"])])}}},xa=pe(uo,[["__scopeId","data-v-e724827f"]]);export{xa as default};
