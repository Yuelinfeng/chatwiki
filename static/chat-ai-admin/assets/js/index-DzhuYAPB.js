var A=Object.defineProperty;var L=(r,e,t)=>e in r?A(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var d=(r,e,t)=>(L(r,typeof e!="symbol"?e+"":e,t),t);async function I(r,e){const t=r.getReader();let o;for(;!(o=await t.read()).done;)e(o.value)}function P(r){let e,t,o,n=!1;return function(u){e===void 0?(e=u,t=0,o=-1):e=D(e,u);const i=e.length;let a=0;for(;t<i;){n&&(e[t]===10&&(a=++t),n=!1);let s=-1;for(;t<i&&s===-1;++t)switch(e[t]){case 58:o===-1&&(o=t-a);break;case 13:n=!0;case 10:s=t;break}if(s===-1)break;r(e.subarray(a,s),o),a=t,o=-1}a===i?e=void 0:a!==0&&(e=e.subarray(a),t-=a)}}function _(r,e,t){let o=S(),n=!1;const f=new TextDecoder;return function(i,a){if(i.length===0)t==null||t(o),o=S(),n=!1;else if(a>0){const s=f.decode(i.subarray(0,a)),b=a+1,l=f.decode(i.subarray(b));switch(s){case"data":o.data=n?o.data+`
`+l:l,n=!0;break;case"event":o.event=l;break;case"id":r(o.id=l);break;case"retry":const y=parseInt(l,10);isNaN(y)||e(o.retry=y);break}}}}function D(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function S(){return{data:"",event:"",id:"",retry:void 0}}var H=function(r,e){var t={};for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&e.indexOf(o)<0&&(t[o]=r[o]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,o=Object.getOwnPropertySymbols(r);n<o.length;n++)e.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(r,o[n])&&(t[o[n]]=r[o[n]]);return t};const g="text/event-stream",M=1e3,C="last-event-id";function W(r,e){var{signal:t,headers:o,onopen:n,onmessage:f,onclose:u,onerror:i,openWhenHidden:a,fetch:s}=e,b=H(e,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise((l,y)=>{const p=Object.assign({},o);p.accept||(p.accept=g);let h;function k(){h.abort(),document.hidden||O()}a||document.addEventListener("visibilitychange",k);let T=M,w=0;function m(){document.removeEventListener("visibilitychange",k),window.clearTimeout(w),h.abort()}t==null||t.addEventListener("abort",()=>{m(),l()});const j=s??window.fetch,x=n??N;async function O(){var E;h=new AbortController;try{const v=await j(r,Object.assign(Object.assign({},b),{headers:p,signal:h.signal}));await x(v),await I(v.body,P(_(c=>{c?p[C]=c:delete p[C]},c=>{T=c},f))),u==null||u(),m(),l()}catch(v){if(!h.signal.aborted)try{const c=(E=i==null?void 0:i(v))!==null&&E!==void 0?E:T;window.clearTimeout(w),w=window.setTimeout(O,c)}catch(c){m(),y(c)}}}O()})}function N(r){const e=r.headers.get("content-type");if(!(e!=null&&e.startsWith(g)))throw new Error(`Expected content-type to be ${g}, Actual: ${e}`)}class F{constructor(e={url:"",data:{}}){d(this,"onOpen");d(this,"onClose");d(this,"onError");d(this,"onMessage");d(this,"opt",{url:"",data:{}});d(this,"controller",new AbortController);d(this,"abort",()=>{this.controller.abort()});this.socketMsgQueue=[],this.opt={...this.opt,...e},this.open()}open(){const e=this;let t=new FormData;for(let n in e.opt.data)t.append(n,e.opt.data[n]);let o={"App-Type":""};this.opt.token&&(o={"App-Type":"",token:this.opt.token}),W(this.opt.url,{method:"POST",headers:o,signal:e.controller.signal,openWhenHidden:!0,body:t,async onopen(n){if(n.ok&&n.headers.get("content-type")===g){typeof e.onOpen=="function"&&e.onOpen();return}else throw n.status>=400&&n.status<500&&n.status!==429?new Error("连接出错"):new Error("连接出错")},onmessage(n){typeof e.onMessage=="function"&&e.onMessage(n)},onclose(){typeof e.onClose=="function"&&e.onClose(),e.controller.abort()},onerror(n){throw typeof e.onError=="function"&&e.onError(n),n}})}}export{F as S};
