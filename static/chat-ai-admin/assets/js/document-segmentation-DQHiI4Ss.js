import{M as _,N as m,a1 as re,a2 as _e,W as t,b as ve,w as xe,B as ne,e as k,a7 as j,F as N,k as n,S as l,$ as Y,Q as Z,Y as v,Z as $,a6 as W,G as fe,H as we,u as ee,aa as he,ai as qe,V as ie,a5 as $e,a4 as Se,a8 as Ie}from"./vue-chunks-DWnFCQSz.js";import{a as Fe,_ as Ce,T as Pe}from"./empty-CqLsGxfj.js";import{b as te,k as le,d as ge,B as ze,M as se,E as pe}from"../../index-CAb1tT-W.js";import{a as Ne,b as Ee,e as Le,f as Te,s as Ue}from"./index-CYunvooy.js";import{M as Oe}from"./model-select-M64UlKaF.js";import{F as ce,_ as je}from"./index-BwLqZyOz.js";import"./index-ZqzVpCxK.js";import{I as ke}from"./Input-DuH7dn02.js";import{Q as De}from"./QuestionCircleOutlined-OoMpIVY2.js";import{S as Be,_ as Qe}from"./index-dibcP1Tn.js";import{_ as Re}from"./index-_2Ia2fBW.js";import{_ as Me}from"./index-Crh3gx22.js";import{_ as Ve}from"./index-DgLE2dBi.js";import{_ as Ae}from"./index-mg07icBV.js";import{U as Je}from"./index-COYYh7hS.js";import{_ as Ke}from"./TextArea-CYqPccpO.js";import{B as Ge,_ as We}from"./index-DGOYM_c-.js";import{S as He}from"./index-BgOt2FQs.js";import{L as Xe}from"./LeftOutlined-EAYnSsOS.js";import"./index-Zgzt-QK_.js";import"./shallowequal-C0Ji8tJB.js";import"./Trigger-JKklW7kX.js";import"./collapseMotion-DNnsVK8G.js";import"./slide-DfWuJDbJ.js";import"./index-B3zCNJkU.js";import"./Dropdown-DKZymAyI.js";import"./useRefs-CH9tJ50T.js";import"./pick-DXKUorQm.js";import"./CheckOutlined-BDgNr5ZU.js";import"./PlusOutlined-lz80p0a0.js";import"./axios-Cm0UX6qg.js";import"./qs-De-rn6vz.js";import"./crypto-js-U6t3rvpm.js";import"./dayjs-BI1HIvBC.js";import"./index-DzhuYAPB.js";import"./index-FFGVkxQ5.js";import"./isPlainObject-BZk97rKt.js";import"./responsiveObserve-9b93vBMn.js";import"./FormItemContext-8D78_qVD.js";import"./index-CviHPZsF.js";import"./Search-DXRfWhTX.js";import"./SearchOutlined-ARjgS9_W.js";import"./inputProps-C93oOyRv.js";import"./Password-CS7ye1e2.js";import"./statusUtils-DZGhn0Kh.js";import"./DownOutlined-DeYc9KSb.js";import"./move-nlQWRDsj.js";import"./UpOutlined-BgTfLOYX.js";import"./colors-DIkUhcQM.js";import"./index-913wQHBS.js";import"./index-DZQM5j1J.js";import"./partition-DzvwyHlm.js";import"./dropdown-ClFVyE-h.js";import"./RightOutlined-BUprEUSn.js";const Ye={},de=g=>(re("data-v-ba7325cb"),g=g(),_e(),g),Ze={class:"empty-box"},et=de(()=>t("img",{src:Fe,alt:""},null,-1)),tt=de(()=>t("div",{class:"title"},"暂无分段",-1)),ot=de(()=>t("div",{class:"info"},"左侧进行分段设置后，点击“生成分段预览",-1)),st=[et,tt,ot];function nt(g,E){return _(),m("div",Ze,st)}const at=te(Ye,[["render",nt],["__scopeId","data-v-ba7325cb"]]),d=g=>(re("data-v-3cc5c1b6"),g=g(),_e(),g),it={class:"segmentation-setting"},lt={class:"setting-items"},ct={class:"setting-item intelligent-setting active"},rt={class:"setting-item-body"},_t=d(()=>t("div",{class:"sub-setting-item-name"},"文件切分",-1)),dt={key:0,class:"custom-setting-form excel-qa-form"},ut={class:"form-item flex"},mt={class:"form-item-box"},pt=d(()=>t("div",{class:"form-item-label"},"问题所在列：",-1)),vt={class:"form-item-body"},ft={class:"form-item-box"},ht=d(()=>t("div",{class:"form-item-label"},"答案所在列：",-1)),gt={class:"form-item-body"},kt=d(()=>t("div",{class:"sub-setting-item-name"},"索引方式",-1)),bt={class:"indexing-methods-box"},yt={class:"list-title-block"},xt=d(()=>t("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复 ",-1)),wt={class:"list-title-block"},qt=d(()=>t("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复 ",-1)),$t=d(()=>t("div",{class:"btn-box-block"},null,-1)),St={class:"btn-box-block"},It={key:1,class:"custom-setting-form"},Ft={class:"form-item"},Ct=d(()=>t("div",{class:"form-item-label"},"问题开始标识符：",-1)),Pt={class:"form-item-body"},zt={class:"form-item"},Nt=d(()=>t("div",{class:"form-item-label"},"答案开始标识符：",-1)),Et={class:"form-item-body"},Lt=d(()=>t("div",{class:"sub-setting-item-name"},"索引方式",-1)),Tt={class:"indexing-methods-box"},Ut={class:"list-title-block"},Ot=d(()=>t("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复 ",-1)),jt={class:"list-title-block"},Dt=d(()=>t("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复 ",-1)),Bt=d(()=>t("div",{class:"btn-box-block"},null,-1)),Qt={class:"btn-box-block"},Rt={key:0,class:"custom-setting-form subsection-form"},Mt={class:"form-item"},Vt=d(()=>t("div",{class:"form-item-label"},"分段方式：",-1)),At={class:"form-item-body"},Jt=d(()=>t("div",{class:"form-item-tip"},"提示：语义分段更适合没有排版过的文章，即没有明显换行符号的文本，否则更推荐使用普通分段",-1)),Kt={class:"select-card-box"},Gt={class:"card-title"},Wt=d(()=>t("div",{class:"card-desc"}," 基于文章中句号、空行，或者自定义符号进行分段，不会消耗模型token ",-1)),Ht={class:"card-title"},Xt=d(()=>t("div",{class:"card-desc"}," 将文章拆分成句子后，通过语句向量相似度进行分段，会消耗模型token ",-1)),Yt={class:"form-item",style:{"margin-bottom":"18px"}},Zt=d(()=>t("div",{class:"form-item-label"},"分段标识符：",-1)),eo={class:"form-item-body"},to={class:"form-item"},oo=d(()=>t("div",{class:"form-item-label"},"分段最大长度：",-1)),so={class:"form-item-body"},no=d(()=>t("span",{class:"unit-text"},"字符",-1)),ao={class:"form-item"},io=d(()=>t("div",{class:"form-item-label not-required"},"分段重叠长度：",-1)),lo={class:"form-item-body"},co=d(()=>t("span",{class:"unit-text"},"字符",-1)),ro={class:"form-item",style:{"margin-bottom":"16px"}},_o=d(()=>t("div",{class:"form-item-label"},"嵌入模型：",-1)),uo={class:"form-item-body"},mo={class:"form-item",style:{"margin-bottom":"16px"}},po={class:"form-item-label"},vo={class:"form-item-body"},fo={class:"form-item"},ho=d(()=>t("div",{class:"form-item-label"},"分段最大长度：",-1)),go={class:"form-item-body"},ko=d(()=>t("span",{class:"unit-text"},"字符",-1)),bo={class:"form-item"},yo=d(()=>t("div",{class:"form-item-label not-required"},"分段重叠长度：",-1)),xo={class:"form-item-body"},wo=d(()=>t("span",{class:"unit-text"},"字符",-1)),qo={class:"btn-box-block"},$o={class:"btn-box-block"},So={__name:"segmentation-setting",props:{mode:{type:Number,default:0},excellQaLists:{type:Array,default:()=>[]},libFileInfo:{type:Object,default:()=>{}},library_type:{default:0}},emits:["change","validate","save"],setup(g,{expose:E,emit:P}){const f=ce.useForm,b=P,p=g;ve(()=>p.libFileInfo.doc_type=="1"&&(p.libFileInfo.file_ext=="docx"||p.libFileInfo.file_ext=="html")),xe(p,c=>{let e=c.libFileInfo,C=e.separators_no?e.separators_no.split(","):[11,12];o.separators_no=C.map(w=>+w),o.chunk_size=+e.chunk_size||512,o.chunk_overlap=+e.chunk_overlap||50,o.question_lable=e.question_lable,o.answer_lable=e.answer_lable,o.question_column=e.question_column||void 0,o.answer_column=e.answer_column||void 0,o.qa_index_type=+e.qa_index_type,o.enable_extract_image=e.enable_extract_image=="true",o.chunk_type=+e.chunk_type,o.semantic_chunk_size=+e.semantic_chunk_size||512,o.semantic_chunk_overlap=+e.semantic_chunk_overlap||50,o.semantic_chunk_threshold=+e.semantic_chunk_threshold||90,o.semantic_chunk_use_model=e.semantic_chunk_use_model||"",o.semantic_chunk_model_config_id=e.semantic_chunk_model_config_id>0?e.semantic_chunk_model_config_id:"",e.chunk_type==0&&(C=e.normal_chunk_default_separators_no?e.normal_chunk_default_separators_no.split(","):[11,12],o.separators_no=C.map(w=>+w),o.chunk_size=+e.normal_chunk_default_chunk_size||512,o.chunk_overlap=+e.normal_chunk_default_chunk_overlap||50,o.chunk_type=+e.default_chunk_type,o.semantic_chunk_size=+e.semantic_chunk_default_chunk_size||512,o.semantic_chunk_overlap=+e.semantic_chunk_default_chunk_overlap||50,o.semantic_chunk_threshold=+e.semantic_chunk_default_threshold||90,setTimeout(()=>{o.semantic_chunk_use_model=e.default_use_model,o.semantic_chunk_model_config_id=e.default_model_config_id>0?e.default_model_config_id:""},100)),o.is_qa_doc=p.library_type==2?1:0});const o=ne({separators_no:[],chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",question_column:void 0,answer_column:void 0,qa_index_type:1,enable_extract_image:!0,chunk_type:1,semantic_chunk_size:512,semantic_chunk_overlap:50,semantic_chunk_threshold:90,semantic_chunk_use_model:"",semantic_chunk_model_config_id:""});let i={};setTimeout(()=>{i=JSON.parse(JSON.stringify(o))},500);const D=k([]),B=c=>{D.value=c},V=()=>{Object.assign(o,i)},S=()=>{b("save")},z=ne({question_lable:[{message:"请输入问题开始标识符",validator:async(c,e)=>o.is_qa_doc==1&&p.mode==0?e?Promise.resolve():Promise.reject("请输入问题开始标识符"):Promise.resolve()}],semantic_chunk_model_config_id:[{message:"请选择嵌入模型",validator:async(c,e)=>o.is_qa_doc==0&&o.chunk_type==2?e?Promise.resolve():Promise.reject("请选择嵌入模型"):Promise.resolve()}],answer_lable:[{message:"请输入答案开始标识符",validator:async(c,e)=>o.is_qa_doc==1&&p.mode==0?e?Promise.resolve():Promise.reject("请输入答案开始标识符"):Promise.resolve()}],separators_no:[{message:"请选择分段标识符",validator:async(c,e)=>p.mode!=1&&o.is_qa_doc==0&&e.length==0&&o.chunk_type==1?Promise.reject("请选择分段标识符"):Promise.resolve()}],chunk_size:[{validator:async(c,e)=>{if(p.mode!=1&&o.chunk_type==1)if(e){if(e>1e4)return Promise.reject("最大分段长最大值不得超过10000")}else return Promise.reject("请输入分段最大长度");return Promise.resolve()}}],chunk_overlap:[{validator:async(c,e)=>p.mode!=1&&o.chunk_type==1&&e>parseInt(o.chunk_size/2)?Promise.reject("分段重叠长度最大不得超过最大分段长度的50%"):Promise.resolve()}],question_column:[{message:"请选择问题所在列",validator:async(c,e)=>p.mode==1&&o.is_qa_doc==1?e?Promise.resolve():Promise.reject("请选择问题所在列"):Promise.resolve()}],answer_column:[{message:"请选择答案所在列",validator:async(c,e)=>p.mode==1&&o.is_qa_doc==1?e?Promise.resolve():Promise.reject("请选择答案所在列"):Promise.resolve()}]}),{resetFields:H,validate:Q,validateInfos:I}=f(o,z),r=k(!1),L=()=>{r.value=!0,q()},q=(c=!0)=>{let e=he(o);Q().then(()=>{b("change",{...e}),b("validate","")}).catch(C=>{const{errorFields:w}=C;if(w.length>0){c&&w[0].name,le.error(w[0].errors[0]),b("validate",w[0].errors[0]),r.value=!1;return}b("validate",""),b("change",{...e})})};let u=null;const F=()=>{u&&(clearTimeout(u),u=null),u=setTimeout(()=>{q()},500)},G=k([]);(()=>{Ne().then(c=>{G.value=c.data||[]})})();const T=c=>{c!=o.qa_index_type&&(o.qa_index_type=c,q())};return E({formState:o,reLoading:r}),(c,e)=>{const C=Be,w=Qe,y=ge,A=ze,X=ke,U=Re,J=Me,oe=Ve;return _(),m("div",it,[t("div",lt,[t("div",ct,[t("div",rt,[j("",!0),o.is_qa_doc==1?(_(),m(N,{key:1},[_t,p.mode==1?(_(),m("div",dt,[t("div",ut,[t("div",mt,[pt,t("div",vt,[n(w,{value:o.question_column,"onUpdate:value":e[2]||(e[2]=a=>o.question_column=a),onChange:F,placeholder:"请选择列名",style:{width:"100%"}},{default:l(()=>[(_(!0),m(N,null,Y(p.excellQaLists,a=>(_(),Z(C,{value:a.value,key:a.value},{default:l(()=>[v($(a.lable),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),t("div",ft,[ht,t("div",gt,[n(w,{value:o.answer_column,"onUpdate:value":e[3]||(e[3]=a=>o.answer_column=a),onChange:F,placeholder:"请选择答案所在列",style:{width:"100%"}},{default:l(()=>[(_(!0),m(N,null,Y(p.excellQaLists,a=>(_(),Z(C,{value:a.value,key:a.value},{default:l(()=>[v($(a.lable),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])])]),kt,t("div",bt,[t("div",{class:W(["list-item",{active:o.qa_index_type==1}]),onClick:e[4]||(e[4]=a=>T(1))},[n(y,{class:"check-icon",name:"check-arrow-filled"}),t("div",yt,[n(y,{name:"file-search"}),v(" 问题与答案一起生成索引 ")]),xt],2),t("div",{class:W(["list-item",{active:o.qa_index_type==2}]),onClick:e[5]||(e[5]=a=>T(2))},[n(y,{class:"check-icon",name:"check-arrow-filled"}),t("div",wt,[n(y,{name:"comment-search"}),v(" 仅对问题生成索引 ")]),qt],2),$t,t("div",St,[n(A,{type:"primary",block:"",onClick:S},{default:l(()=>[v("保存")]),_:1})])])])):(_(),m("div",It,[n(U,{gap:16},{default:l(()=>[t("div",Ft,[Ct,t("div",Pt,[n(X,{placeholder:"请输入标识符",value:o.question_lable,"onUpdate:value":e[6]||(e[6]=a=>o.question_lable=a),onChange:F},null,8,["value"])])]),t("div",zt,[Nt,t("div",Et,[n(X,{placeholder:"请输入标识符",value:o.answer_lable,"onUpdate:value":e[7]||(e[7]=a=>o.answer_lable=a),onChange:F},null,8,["value"])])])]),_:1}),Lt,t("div",Tt,[t("div",{class:W(["list-item",{active:o.qa_index_type==1}]),onClick:e[8]||(e[8]=a=>T(1))},[n(y,{class:"check-icon",name:"check-arrow-filled"}),t("div",Ut,[n(y,{name:"file-search"}),v(" 问题与答案一起生成索引 ")]),Ot],2),t("div",{class:W(["list-item",{active:o.qa_index_type==2}]),onClick:e[9]||(e[9]=a=>T(2))},[n(y,{class:"check-icon",name:"check-arrow-filled"}),t("div",jt,[n(y,{name:"comment-search"}),v(" 仅对问题生成索引 ")]),Dt],2),Bt,t("div",Qt,[n(A,{type:"primary",block:"",onClick:S},{default:l(()=>[v("保存")]),_:1})])])]))],64)):(_(),m(N,{key:2},[p.mode!=1?(_(),m("div",Rt,[t("div",Mt,[Vt,t("div",At,[Jt,t("div",Kt,[t("div",{class:W(["select-card-item",{active:o.chunk_type==1}]),onClick:e[10]||(e[10]=a=>o.chunk_type=1)},[n(y,{class:"check-arrow",name:"check-arrow-filled"}),t("div",Gt,[n(y,{name:"ordinary-segmentation",class:"title-icon"}),v(" 普通分段 ")]),Wt],2),t("div",{class:W(["select-card-item",{active:o.chunk_type==2}]),onClick:e[11]||(e[11]=a=>o.chunk_type=2)},[n(y,{class:"check-arrow",name:"check-arrow-filled"}),t("div",Ht,[n(y,{name:"semantic-segmentation",class:"title-icon"}),v(" 语义分段 ")]),Xt],2)])])]),o.chunk_type==1?(_(),m(N,{key:0},[t("div",Yt,[Zt,t("div",eo,[n(w,{placeholder:"请选择",style:{width:"100%"},mode:"multiple",value:o.separators_no,"onUpdate:value":e[12]||(e[12]=a=>o.separators_no=a)},{default:l(()=>[(_(!0),m(N,null,Y(G.value,a=>(_(),Z(C,{value:a.no,key:a.no},{default:l(()=>[v($(a.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),n(U,{gap:16},{default:l(()=>[t("div",to,[oo,t("div",so,[n(U,{align:"center",gap:8},{default:l(()=>[n(J,{style:{flex:"1"},value:o.chunk_size,"onUpdate:value":e[13]||(e[13]=a=>o.chunk_size=a),placeholder:"分段最大长度",min:200,max:1e4,precision:0,formatter:a=>parseInt(a),parser:a=>parseInt(a)},null,8,["value","formatter","parser"]),no]),_:1})])]),t("div",ao,[io,t("div",lo,[n(U,{align:"center",gap:8},{default:l(()=>[n(J,{style:{flex:"1"},value:o.chunk_overlap,"onUpdate:value":e[14]||(e[14]=a=>o.chunk_overlap=a),placeholder:"分段重叠长度",min:0,formatter:a=>parseInt(a),parser:a=>parseInt(a)},null,8,["value","formatter","parser"]),co]),_:1})])])]),_:1})],64)):j("",!0),fe(t("div",null,[t("div",ro,[_o,t("div",uo,[n(Oe,{modelType:"TEXT EMBEDDING",modeName:o.semantic_chunk_use_model,"onUpdate:modeName":e[15]||(e[15]=a=>o.semantic_chunk_use_model=a),modeId:o.semantic_chunk_model_config_id,"onUpdate:modeId":e[16]||(e[16]=a=>o.semantic_chunk_model_config_id=a),style:{width:"100%"},onLoaded:B},null,8,["modeName","modeId"])])]),t("div",mo,[t("div",po,[v(" 分段阈值 "),n(oe,null,{title:l(()=>[v("用于控制分段拆分的标准，数值0~100,数值越大，分段越少，数值越小，分段越多。")]),default:l(()=>[n(ee(De),{style:{cursor:"pointer","margin-left":"2px"}})]),_:1}),v("： ")]),t("div",vo,[n(J,{style:{width:"100%"},value:o.semantic_chunk_threshold,"onUpdate:value":e[17]||(e[17]=a=>o.semantic_chunk_threshold=a),placeholder:"请输入分段阈值",precision:0,min:0,max:100},null,8,["value"])])]),n(U,{gap:16},{default:l(()=>[t("div",fo,[ho,t("div",go,[n(U,{align:"center",gap:8},{default:l(()=>[n(J,{style:{flex:"1"},value:o.semantic_chunk_size,"onUpdate:value":e[18]||(e[18]=a=>o.semantic_chunk_size=a),placeholder:"分段最大长度",min:200,max:1e4,precision:0,formatter:a=>parseInt(a),parser:a=>parseInt(a)},null,8,["value","formatter","parser"]),ko]),_:1})])]),t("div",bo,[yo,t("div",xo,[n(U,{align:"center",gap:8},{default:l(()=>[n(J,{style:{flex:"1"},value:o.semantic_chunk_overlap,"onUpdate:value":e[19]||(e[19]=a=>o.semantic_chunk_overlap=a),placeholder:"分段重叠长度",min:0,formatter:a=>parseInt(a),parser:a=>parseInt(a)},null,8,["value","formatter","parser"]),wo]),_:1})])])]),_:1})],512),[[we,o.chunk_type==2]]),t("div",qo,[n(A,{onClick:V,style:{flex:"1"}},{default:l(()=>[v("重置")]),_:1}),n(A,{onClick:L,loading:r.value,style:{flex:"1"},type:"primary",ghost:""},{default:l(()=>[v("生成分段预览")]),_:1},8,["loading"])]),t("div",$o,[n(A,{type:"primary",block:"",onClick:S},{default:l(()=>[v("保存")]),_:1})])])):j("",!0)],64))])])])])}}},Io=te(So,[["__scopeId","data-v-3cc5c1b6"]]),Fo={class:"document-fragment"},Co={class:"fragment-header"},Po={class:"fragment-info"},zo={class:"fragment-number"},No={key:0,class:"fragment-title"},Eo={class:"fragment-content-lenght"},Lo={class:"fragment-action"},To={class:"fragment-content"},Uo={key:0,class:"fragment-content"},Oo={key:1,class:"fragment-content"},jo={class:"fragment-img"},Do=["src"],Bo={__name:"document-fragment",props:{number:{type:[Number,String]},total:{type:[Number,String]},title:{type:[Number,String]},content:{type:[Number,String]},question:{type:[Number,String]},answer:{type:[Number,String]},images:{type:[Array,String]}},emits:["edit","delete"],setup(g,{emit:E}){const P=E,f=g,b=()=>{P("edit")},p=()=>{P("delete")};return(o,i)=>{const D=Ae,B=qe("viewer");return _(),m("div",Fo,[t("div",Co,[t("div",Po,[t("span",zo,"#"+$(f.number),1),f.title?(_(),m("span",No,$(f.title),1)):j("",!0),t("span",Eo,"共"+$(f.total)+"个字符",1)]),t("div",Lo,[t("a",{onClick:b},"编辑"),n(D,{type:"vertical"}),t("a",{onClick:p},"删除")])]),t("div",To,$(f.content),1),f.question?(_(),m("div",Uo,"Q："+$(f.question),1)):j("",!0),f.answer?(_(),m("div",Oo,"A："+$(f.answer),1)):j("",!0),fe((_(),m("div",jo,[(_(!0),m(N,null,Y(f.images,(V,S)=>(_(),m("img",{key:S,src:V,alt:""},null,8,Do))),128))])),[[B]])])}}},Qo=te(Bo,[["__scopeId","data-v-eee20cea"]]),Ro={class:"upload-box-wrapper"},Mo={key:0},Vo={__name:"edit-fragment-alert",emits:["ok"],setup(g,{expose:E,emit:P}){const f=P,b=k("1"),p=ce.useForm,o=k(!1),i=ne({title:"",content:"",question:"",answer:"",images:[]}),D=ne({content:[{message:"请输入分段内容",validator:async(I,r)=>z.value||r?Promise.resolve():Promise.reject("请输入分段内容")}],question:[{message:"请输入分段问题",validator:async(I,r)=>z.value?r?Promise.resolve():Promise.reject("请输入分段问题"):Promise.resolve()}],answer:[{message:"请输入分段答案",validator:async(I,r)=>z.value?r?Promise.resolve():Promise.reject("请输入分段答案"):Promise.resolve()}]}),{resetFields:B,validate:V,validateInfos:S}=p(i,D),z=k(!1),H=({title:I,content:r,question:L,answer:q,images:u})=>{i.title=I,i.content=r,i.question=L,i.answer=q,i.images=u||[],z.value=L!="",o.value=!0},Q=()=>{V().then(()=>{o.value=!1,f("ok",he(i))})};return E({open:H}),(I,r)=>{const L=ke,q=je,u=Ke,F=ge,G=Ce,R=Pe,T=ce,c=se;return _(),m("div",null,[n(c,{open:o.value,"onUpdate:open":r[6]||(r[6]=e=>o.value=e),title:"编辑分段",onOk:Q,width:"746px"},{default:l(()=>[n(T,{layout:"vertical"},{default:l(()=>[n(q,{label:"分段标题："},{default:l(()=>[n(L,{type:"text",placeholder:"请输入分段标题",value:i.title,"onUpdate:value":r[0]||(r[0]=e=>i.title=e)},null,8,["value"])]),_:1}),z.value?(_(),m(N,{key:0},[n(q,ie({label:"分段问题："},ee(S).question),{default:l(()=>[n(u,{placeholder:"请输入分段问题",value:i.question,"onUpdate:value":r[1]||(r[1]=e=>i.question=e),style:{height:"100px"}},null,8,["value"])]),_:1},16),n(q,ie({label:"分段答案："},ee(S).answer),{default:l(()=>[n(u,{placeholder:"请输入分段答案",value:i.answer,"onUpdate:value":r[2]||(r[2]=e=>i.answer=e),style:{height:"140px"}},null,8,["value"])]),_:1},16)],64)):(_(),Z(q,ie({key:1,label:"分段内容："},ee(S).content),{default:l(()=>[n(u,{placeholder:"请输入分段内容",value:i.content,"onUpdate:value":r[3]||(r[3]=e=>i.content=e),style:{height:"150px"}},null,8,["value"])]),_:1},16)),n(q,{label:"附件"},{default:l(()=>[t("div",Ro,[n(R,{activeKey:b.value,"onUpdate:activeKey":r[4]||(r[4]=e=>b.value=e),size:"small"},{default:l(()=>[n(G,{key:"1"},{tab:l(()=>[t("span",null,[n(F,{name:"img-icon",style:{"font-size":"14px",color:"#2475fc"}}),v(" 图片 "),i.images.length?(_(),m("span",Mo,"("+$(i.images.length)+")",1)):j("",!0)])]),_:1})]),_:1},8,["activeKey"]),n(Je,{value:i.images,"onUpdate:value":r[5]||(r[5]=e=>i.images=e)},null,8,["value"])])]),_:1})]),_:1})]),_:1},8,["open"])])}}},Ao=te(Vo,[["__scopeId","data-v-2c62871c"]]),be=g=>(re("data-v-56b4be2b"),g=g(),_e(),g),Jo={key:0,class:"loading-wrap"},Ko={class:"document-segmentation"},Go={class:"breadcrumb-block"},Wo={class:"page-title"},Ho=be(()=>t("span",{class:"title"},"文档分段与清洗",-1)),Xo={class:"page-container"},Yo={class:"page-left"},Zo={class:"page-right"},es={class:"document-fragment-preview"},ts={class:"preview-header"},os=be(()=>t("span",{class:"label-text"},"分段预览",-1)),ss={class:"fragment-number"},ns={__name:"document-segmentation",setup(g){const E=$e(),P=Se(),{document_id:f}=E.query,b=k(!0),p=k(1);let o=!1,i={id:f,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0},D=!1;const B=k(null),V=s=>{typeof s.separators_no=="object"&&(s.separators_no=s.separators_no.join(",")),D=!0,i={...i,...s},o?se.confirm({title:"提醒",icon:n(pe),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){o=!1,R()},onCancel(){}}):(o=!1,R())};let S=60*10,z=0,H=null;const Q=k({}),I=k(0),r=()=>{b.value||(b.value=!0),Ee({id:f}).then(async s=>{const{status:h}=s.data;if(I.value=s.data.library_type,Q.value=s.data,i={...i,separators_no:s.data.separators_no||"11,12",chunk_size:+s.data.chunk_size||512,chunk_overlap:+s.data.chunk_overlap||50,is_qa_doc:I.value==2?1:0,question_lable:s.data.question_lable,answer_lable:s.data.answer_lable,question_column:s.data.question_column,answer_column:s.data.answer_column,enable_extract_image:s.data.enable_extract_image=="true",qa_index_type:+s.data.qa_index_type,chunk_type:+s.data.chunk_type,semantic_chunk_size:+s.data.semantic_chunk_size||512,semantic_chunk_overlap:+s.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+s.data.semantic_chunk_threshold||90,semantic_chunk_use_model:s.data.semantic_chunk_use_model||"",semantic_chunk_model_config_id:s.data.semantic_chunk_model_config_id>0?s.data.semantic_chunk_model_config_id:""},s.data.chunk_type==0&&(i={...i,separators_no:s.data.normal_chunk_default_separators_no,chunk_size:s.data.normal_chunk_default_chunk_size,chunk_overlap:s.data.normal_chunk_default_chunk_overlap,chunk_type:+s.data.default_chunk_type,semantic_chunk_size:+s.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+s.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+s.data.semantic_chunk_default_threshold,semantic_chunk_use_model:s.data.default_use_model||"",semantic_chunk_model_config_id:s.data.default_model_config_id>0?s.data.default_model_config_id:""}),h==0){if(z++,z>S){se.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{r()},1e3)}else h==4||h==2?(b.value=!1,p.value=parseInt(s.data.is_table_file),H=s.data.library_id,I.value==2?(i.question_lable||i.question_column)&&R():R()):P.replace("/library/details?id="+s.data.library_id);s.data.is_table_file==1&&q()})};r();const L=k([]),q=()=>{Le({id:f}).then(s=>{let h=[];for(let x in s.data)h.push({lable:s.data[x],value:x});L.value=h})},u=k([]),F=k(0),G=ve(()=>F.value<=0),R=()=>Te({...i,semantic_chunk_model_config_id:i.semantic_chunk_model_config_id?+i.semantic_chunk_model_config_id:0}).then(s=>{u.value=s.data.list||[],F.value=s.data.list.length||0}).finally(()=>{B.value.reLoading=!1}),T=k(null);let c=null;const e=({title:s,content:h,question:x,answer:M,images:K},ae)=>{c=ae,T.value.open({title:s,content:h,question:x,answer:M,images:K})},C=({title:s,content:h,question:x,answer:M,images:K})=>{(u.value[c].title!=s||u.value[c].content!=h||u.value[c].question!=x||u.value[c].answer!=M)&&(o=!0),u.value[c].title=s,u.value[c].content=h,u.value[c].question=x,u.value[c].answer=M,u.value[c].images=K,u.value[c].word_total=M.length+x.length+h.length},w=s=>{se.confirm({title:"提醒",icon:n(pe),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){o=!0,u.value.splice(s,1)},onCancel(){}})},y=k(""),A=s=>{y.value=s},X=k(!1),U=()=>{let s=B.value.formState;s=JSON.parse(JSON.stringify(s)),typeof s.separators_no=="object"&&(s.separators_no=s.separators_no.join(",")),i={...i,...s}},J=async()=>{if(U(),await R(),y.value)return le.error(y.value);let s={...i,semantic_chunk_model_config_id:i.semantic_chunk_model_config_id?+i.semantic_chunk_model_config_id:0,is_table_file:p.value};delete s.id;let h={id:f,word_total:F.value,split_params:JSON.stringify(s),list:JSON.stringify(u.value)};s.is_qa_doc==1&&(h.qa_index_type=s.qa_index_type),X.value=!0,Ue(h).then(()=>{if(le.success("保存成功"),E.query.source=="preview"&&!D){ue();return}P.replace("/library/details?id="+H)}).finally(()=>{X.value=!1}).catch(x=>{x.data&&x.data.index&&a(x.data.index)})},oe=k(null),a=s=>{s=s-1;let h=oe.value.querySelectorAll(".fragment-item");h.length>=s&&h[s].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},ue=()=>{P.back()};return(s,h)=>{const x=He,M=Ie("router-link"),K=We,ae=Ge;return _(),m(N,null,[b.value?(_(),m("div",Jo,[n(x)])):j("",!0),t("div",Ko,[t("div",Go,[n(ae,null,{default:l(()=>[n(K,null,{default:l(()=>[n(M,{to:"/library/list"},{default:l(()=>[v(" 知识库管理 ")]),_:1})]),_:1}),n(K,null,{default:l(()=>[n(M,{to:{path:"/library/details/knowledge-document",query:{id:Q.value.library_id}}},{default:l(()=>[v($(Q.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),n(K,null,{default:l(()=>[v("分段设置")]),_:1})]),_:1})]),t("div",Wo,[n(ee(Xe),{onClick:ue}),Ho]),t("div",Xo,[t("div",Yo,[n(Io,{excellQaLists:L.value,libFileInfo:Q.value,library_type:I.value,mode:p.value,ref_key:"segmentationSettingRef",ref:B,onChange:V,onSave:J,onValidate:A},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),t("div",Zo,[t("div",es,[t("div",ts,[os,t("span",ss,"共"+$(F.value)+"个分段",1)]),G.value?(_(),Z(at,{key:0})):j("",!0),t("div",{class:"preview-box",ref_key:"previewBoxRef",ref:oe},[(_(!0),m(N,null,Y(u.value,(O,me)=>(_(),m("div",{class:"fragment-item",key:O.number},[n(Qo,{number:O.number,title:O.title,content:O.content,total:O.word_total,question:O.question,answer:O.answer,images:O.images,onDelete:ye=>w(me),onEdit:ye=>e(O,me)},null,8,["number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),n(Ao,{ref_key:"editFragmentAlertRef",ref:T,onOk:C},null,512)])],64)}}},an=te(ns,[["__scopeId","data-v-56b4be2b"]]);export{an as default};
