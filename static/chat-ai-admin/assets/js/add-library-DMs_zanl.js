import{_ as fe,e as j,bn as T,S as ve,N as ye,T as ge,c as he,B as be}from"../../index-CyiwD4fB.js";import{$ as ke,r as h,b as xe,A as z,v as qe,L as _,M as f,V as d,j as l,Q as n,U as b,u as k,F as N,a1 as A,a2 as E,Y as y,P as q,a8 as F,E as M,G as I,X as v,a7 as we,a3 as Ne,a4 as Ae}from"./vue-chunks-CwaUyaYI.js";import{U as Se}from"./upload-input-Cb6VRtKL.js";import{c as Ce}from"./index-CnXWAABj.js";import{c as Ue}from"./index-BWAwk653.js";import{A as Ee}from"./avatar-input-CJgW6Rj5.js";import{t as $}from"./validate-8MtiUsxW.js";import{F as G,_ as Fe}from"./index-BfwAi9te.js";import"./index-D8wyBl4m.js";import{I as Me}from"./Input-Da8aOOO7.js";import"./index-DzmLM5l_.js";import{R as Ie,_ as Le}from"./RadioButton-DM2pQQZg.js";import{_ as Oe}from"./TextArea-CBrdn4Xi.js";import{S as Te,_ as De,a as Pe}from"./index-BfzgEQpv.js";import{_ as Be}from"./index-BttTL6gl.js";import"./dayjs-9pTjq58W.js";import"./axios-Cm0UX6qg.js";import"./qs-DFTLuGGg.js";import"./crypto-js-Dhiry31a.js";import"./InboxOutlined-8QqjwpQc.js";import"./index-CmFdMhoo.js";import"./partition-D90jzHoI.js";import"./colors-DcCY69fx.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-DAieTXDw.js";import"./inputProps-CBCbV3dR.js";import"./index-D97187b8.js";import"./CheckOutlined-s6Wk7FwS.js";import"./useRefs-kFALIf8n.js";import"./collapseMotion-1cFzdZPo.js";import"./FormItemContext-P-hc85qB.js";import"./PlusOutlined-C0mU79gr.js";import"./responsiveObserve-DlRq3u3d.js";import"./QuestionCircleOutlined-CGJPYPeU.js";import"./index-B-VUp88E.js";import"./Search-DC1Sahrq.js";import"./SearchOutlined-eG2BTg8a.js";import"./index-gIgkZ2l6.js";import"./slide-kUXvfLu3.js";import"./isMobile-D_4OiXLP.js";import"./DownOutlined-D6oDy9l0.js";import"./move-7FTT7O3Y.js";const Re=S=>(Ne("data-v-766c44ee"),S=S(),Ae(),S),Ve={class:"add-library-page"},je={class:"form-box"},ze=Re(()=>d("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1)),$e={class:"upload-document-type-box"},Ge=["onClick"],Je={class:"right-block"},Qe={class:"title-block"},Xe={class:"title-text"},Ye={class:"desc"},He={class:"upload-document-type-box"},Ke=["onClick"],We={class:"right-block"},Ze={class:"title-block"},eo={class:"title-text"},oo={class:"desc"},ao={class:"card-box"},lo=["onClick"],to=["src"],no={key:0},io={key:1},ro={__name:"add-library",setup(S){const{getStorage:J,setStorage:Q,removeStorage:D}=ye("localStorage");j.config({duration:2});const P=ke(),L=["azure","ollama","xinference","openaiAgent"],X=["azure"],Y=h([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"},{iconName:"economic",iconNameActive:"economic-active",title:"经济",value:2,is_offline:!0,desc:"使用离线的向量模型，较在线模型准确度稍低，但是不需要消耗token"}]),H=h([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:"上传本地 text/pdf/doc/docx/xlsx 等格式文件"},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]),K=h([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),W=G.useForm,C=h(!1),p=xe(()=>J("lastEmbeddedModel")||{}),x=h(p.value.isActive?p.value.isActive:2),e=z({library_name:"",library_intro:"",use_model:p.value.use_model?p.value.use_model:void 0,model_config_id:p.value.model_config_id?p.value.model_config_id:"",library_files:void 0,avatar:T,robot_avatar_url:T,is_offline:Object.prototype.hasOwnProperty.call(p.value,"is_offline")?p.value.is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:0,qa_index_type:1,doc_auto_renew_frequency:1}),B=h(""),Z=z({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],library_intro:[{required:!0,message:"请输入库简介",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:!0,message:"请选择文件",trigger:"change",validator:(a,t)=>t&&t.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件"))}],urls:[{required:!0,validator:(a,t)=>e.doc_type!=2?Promise.resolve():$(t)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve()}],file_name:[{required:!0,validator:(a,t)=>e.doc_type!=3||t?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:ee,validateInfos:g}=W(e,Z),oe=a=>{e.library_files=a},ae=(a,t)=>{const s=t.current_obj;e.use_model=L.indexOf(s.model_define)>-1&&s.deployment_name?s.deployment_name:s.name,B.value=s.model_define,e.model_config_id=s.id||t.model_config_id},le=a=>{e.avatar=a.file},te=a=>{e.is_offline=a.is_offline,x.value=a.value,e.use_model=void 0,O(a.is_offline)},ne=a=>{e.doc_type=a},ie=a=>{e.qa_index_type=a},re=()=>{P.back()},de=()=>{ee().then(()=>{se()}).catch(a=>{})},se=()=>{let a=new FormData,t=JSON.parse(JSON.stringify(e));X.indexOf(B.value)>-1&&(t.use_model="默认"),a.append("library_name",e.library_name),a.append("library_intro",e.library_intro),a.append("use_model",t.use_model),a.append("model_config_id",e.model_config_id),a.append("avatar",e.avatar||T),a.append("is_offline",e.is_offline),a.append("urls",JSON.stringify($(e.urls))),a.append("doc_type",e.doc_type),a.append("file_name",e.file_name),a.append("is_qa_doc",e.is_qa_doc),a.append("qa_index_type",e.qa_index_type),a.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),Q("lastEmbeddedModel",{model_config_id:e.model_config_id,is_offline:e.is_offline,use_model:e.use_model,isActive:x.value});let s=!1;e.doc_type==1&&e.library_files.forEach(i=>{(i.name.includes(".xlsx")||i.name.includes(".csv"))&&(s=!0),a.append("library_files",i)}),C.value=!0,Ce(a).then(i=>{j.success("创建成功");let c="/library/details/knowledge-document",r={id:i.data.id};s&&(c="/library/document-segmentation",r={document_id:i.data.file_ids[0]}),e.doc_type==3&&(c="/library/preview",r={id:i.data.file_ids[0]}),P.replace({path:c,query:r}),C.value=!1}).catch(()=>{C.value=!1})},w=h([]);function _e(a,t,s){const i=new Set(a.map(c=>c.model_define));return t.filter(c=>{let r=c[s];i.has(r)&&a.filter(u=>{if(u.model_define==r)return u.children=ge(u.children,c.children),!1})}),a}const O=a=>{Ue({model_type:"TEXT EMBEDDING",is_offline:a}).then(t=>{let s=t.data||[],i=[],c=!1;!s.length&&p.value.model_config_id&&(e.use_model=void 0,D("lastEmbeddedModel")),w.value=s.map(r=>{i=[];for(let u=0;u<r.model_info.vector_model_list.length;u++){const U=r.model_info.vector_model_list[u];i.push({name:U,deployment_name:r.model_config.deployment_name,id:r.model_config.id,model_define:r.model_info.model_define})}return r.model_config.id==p.value.model_config_id&&(c=!0),{id:r.model_config.id,name:r.model_info.model_name,model_define:r.model_info.model_define,icon:r.model_info.model_icon_url,children:i,deployment_name:r.model_config.deployment_name}}),c||(e.use_model=void 0,D("lastEmbeddedModel")),w.value=_e(ve(w.value,"model_define"),w.value,"model_define")})};return qe(()=>{Object.prototype.hasOwnProperty.call(p.value,"is_offline")?O(p.value.is_offline):O(!0)}),(a,t)=>{const s=Me,i=Fe,c=Oe,r=he,u=Te,U=De,R=Ie,ce=Le,ue=Be,me=Pe,V=be,pe=G;return _(),f("div",Ve,[d("div",je,[l(pe,{"label-col":{span:5}},{default:n(()=>[l(i,b({ref:"name",label:"知识库名称"},k(g).library_name),{default:n(()=>[l(s,{value:e.library_name,"onUpdate:value":t[0]||(t[0]=o=>e.library_name=o),placeholder:"请输入知识库名称，最多20个字"},null,8,["value"])]),_:1},16),l(i,b({label:"知识库简介"},k(g).library_intro),{default:n(()=>[l(c,{value:e.library_intro,"onUpdate:value":t[1]||(t[1]=o=>e.library_intro=o),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1},16),l(i,b({ref:"name",label:"知识库封面"},k(g).robot_avatar_url),{default:n(()=>[l(Ee,{value:e.robot_avatar_url,"onUpdate:value":t[2]||(t[2]=o=>e.robot_avatar_url=o),onChange:le},null,8,["value"]),ze]),_:1},16),l(i,{label:"导入文档类型",required:""},{default:n(()=>[d("div",$e,[(_(!0),f(N,null,A(H.value,o=>(_(),f("div",{class:E(["type-item",{active:e.doc_type==o.value}]),key:o.value,onClick:m=>ne(o.value)},[d("div",Je,[d("div",Qe,[l(r,{name:e.doc_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),d("div",Xe,y(o.title),1)]),d("div",Ye,y(o.desc),1)]),e.doc_type==o.value?(_(),q(r,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):F("",!0)],10,Ge))),128))])]),_:1}),M(l(i,b({ref:"name",label:"知识库文档"},k(g).library_files),{default:n(()=>[l(Se,{onChange:oe})]),_:1},16),[[I,e.doc_type==1]]),M(l(i,b({ref:"urls",label:"网页链接"},k(g).urls),{default:n(()=>[l(c,{style:{height:"120px"},value:e.urls,"onUpdate:value":t[3]||(t[3]=o=>e.urls=o),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[I,e.doc_type==2]]),M(l(i,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:n(()=>[l(U,{value:e.doc_auto_renew_frequency,"onUpdate:value":t[4]||(t[4]=o=>e.doc_auto_renew_frequency=o),style:{width:"100%"}},{default:n(()=>[l(u,{value:1},{default:n(()=>[v("不自动更新")]),_:1}),l(u,{value:2},{default:n(()=>[v("每天")]),_:1}),l(u,{value:3},{default:n(()=>[v("每3天")]),_:1}),l(u,{value:4},{default:n(()=>[v("每7天")]),_:1}),l(u,{value:5},{default:n(()=>[v("每30天")]),_:1})]),_:1},8,["value"])]),_:1},512),[[I,e.doc_type==2]]),M(d("div",null,[l(i,b({ref:"file_name",label:"文档名称"},k(g).file_name),{default:n(()=>[l(s,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":t[5]||(t[5]=o=>e.file_name=o)},null,8,["value"])]),_:1},16),l(i,{label:"文档类型",required:""},{default:n(()=>[l(ce,{value:e.is_qa_doc,"onUpdate:value":t[6]||(t[6]=o=>e.is_qa_doc=o)},{default:n(()=>[l(R,{value:0},{default:n(()=>[v("普通文档")]),_:1}),l(R,{value:1},{default:n(()=>[v("QA文档")]),_:1})]),_:1},8,["value"])]),_:1}),e.is_qa_doc==1?(_(),q(i,{key:0,label:"索引方式",required:""},{default:n(()=>[d("div",He,[(_(!0),f(N,null,A(K.value,o=>(_(),f("div",{class:E(["type-item",{active:e.qa_index_type==o.value}]),key:o.value,onClick:m=>ie(o.value)},[d("div",We,[d("div",Ze,[l(r,{name:e.qa_index_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),d("div",eo,y(o.title),1)]),d("div",oo,y(o.desc),1)]),e.qa_index_type==o.value?(_(),q(r,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):F("",!0)],10,Ke))),128))])]),_:1})):F("",!0)],512),[[I,e.doc_type==3]]),l(i,b({label:"嵌入模型 "},k(g).use_model),{default:n(()=>[d("div",ao,[(_(!0),f(N,null,A(Y.value,o=>(_(),f("div",{class:E(["use-model-item",{active:x.value==o.value}]),key:o.value,onClick:m=>te(o)},[d("div",{class:E(["use-model-item-top",{active:x.value==o.value}])},[l(r,{class:"use-model-item-top-icon",style:{color:"red"},name:x.value==o.value?o.iconNameActive:o.iconName},null,8,["name"]),d("p",null,y(o.title),1)],2),d("p",null,y(o.desc),1),x.value==o.value?(_(),q(r,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):F("",!0)],10,lo))),128))]),l(U,{value:e.use_model,"onUpdate:value":t[7]||(t[7]=o=>e.use_model=o),placeholder:"请选择嵌入模型",onChange:ae},{default:n(()=>[(_(!0),f(N,null,A(w.value,o=>(_(),q(me,{key:o.id},{label:n(()=>[l(ue,{align:"center",gap:6},{default:n(()=>[d("img",{class:"model-icon",src:o.icon,alt:""},null,8,to),v(y(o.name),1)]),_:2},1024)]),default:n(()=>[(_(!0),f(N,null,A(o.children,m=>(_(),q(u,{value:L.indexOf(o.model_define)>-1&&m.deployment_name?m.deployment_name:m.name+m.id,model_config_id:o.id,current_obj:m,key:m.name+m.id},{default:n(()=>[L.indexOf(o.model_define)>-1&&m.deployment_name?(_(),f("span",no,y(m.deployment_name),1)):(_(),f("span",io,y(m.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),l(i,{"wrapper-col":{span:14,offset:4}},{default:n(()=>[l(V,{onClick:re},{default:n(()=>[v("取 消")]),_:1}),l(V,{type:"primary",style:{"margin-left":"16px"},loading:C.value,onClick:we(de,["prevent"])},{default:n(()=>[v("下一步")]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},Zo=fe(ro,[["__scopeId","data-v-766c44ee"]]);export{Zo as default};
