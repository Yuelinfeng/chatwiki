import{J as H,r as v,A as j}from"./vue-chunks-Bxyh5WP6.js";import{b as K,s as Q,q as X,d as w,e as Y,f as Z,h as ee}from"./index-Vr5IbFke.js";import{p as ae}from"./index-xJ7lndAQ.js";import{bk as M,bl as L,$ as g}from"../../index-CWYf_R7c.js";import{u as te,a as oe}from"./useIM-C-Li-ntS.js";const le=H("chat",()=>{const q=te(),i=v([]),h=oe();let c=null;const l=v(0),_=v(""),s=j({admin_user_id:"",avatar:"",id:"",name:"",nickname:"",openid:""}),o=j({id:"",library_ids:"",form_ids:"",prompt:"",robot_avatar:"",robot_intro:"",robot_key:"",robot_name:"",openid:"",welcomes:{reasoning_content:"",content:"",question:[]},enable_question_guide:!1,enable_common_question:!1,common_question_list:[]}),C=async e=>{i.value=[],p.value=!1,m.value=!1,e.dialogue_id?l.value=e.dialogue_id:l.value=0,_.value=e.openid||M(),o.robot_key=e.robot_key,o.openid=_.value,s.openid=_.value,s.avatar=e.avatar||L,s.name=e.name||"",s.nickname=e.nickname||""},b=v(!1),S=async e=>{c&&(c.abort(),c=null),i.value=[],p.value=!1,m.value=!1,e.dialogue_id?(b.value=!1,l.value=e.dialogue_id):(b.value=!0,l.value=0),_.value=e.openid||M(e.robot_key),o.robot_key=e.robot_key,o.openid=_.value,s.openid=_.value,s.avatar=e.avatar||L,s.name=e.name||"",s.nickname=e.nickname||"";const t=await K({robot_key:o.robot_key,openid:_.value,nickname:s.nickname,name:s.name,is_background:e.is_background||void 0});try{let u=t.data.customer,a=t.data.robot;return s.admin_user_id=u.admin_user_id,s.avatar=u.avatar,s.id=u.id,s.name=u.name,s.nickname=u.nickname,o.library_ids=a.library_ids,o.prompt=a.prompt,o.robot_avatar=a.robot_avatar,o.robot_intro=a.robot_intro,o.robot_key=a.robot_key,o.robot_name=a.robot_name,o.form_ids=a.form_ids,o.id=a.id,o.enable_question_guide=a.enable_question_guide=="true",o.enable_common_question=a.enable_common_question=="true",o.common_question_list=a.common_question_list,a.welcomes&&(o.welcomes=JSON.parse(a.welcomes)),J(t.data.message),h.connect(_.value),h.on("message",N),t}catch(u){Promise.reject(u)}},N=e=>{e&&e.msg_type!="receiver_notify"&&e.dialogue_id==l.value&&(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.robot_avatar=o.robot_avatar,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),i.value.push(e),q.emit("updateAiMessage",e))},J=e=>{e&&(e.uid=g(32),e.loading=!1,e.isWelcome=!0,e.robot_avatar=o.robot_avatar,e.menu_json&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&(e.quote_file=JSON.parse(e.quote_file)),i.value.push(e))},O=e=>{e.uid=g(32),e.loading=!1,e.avatar=s.avatar,e.openid=s.openid,e.msg_type=1,e.is_customer=1,i.value.push(e)},A=e=>{i.value.push(e),q.emit("updateAiMessage",e)},d=(e,t,u)=>{let a=i.value.findIndex(n=>n.uid==u);if(e=="reasoning_content"){let n=i.value[a].reasoning_content||"";i.value[a].reasoning_content=n+t,i.value[a].reasoning_status=!0,i.value[a].show_reasoning=!0}if(e=="sending"){i.value[a].reasoning_status=!1;let n=i.value[a].content||"";i.value[a].content=n+t}if(e=="quote_file"&&(i.value[a].quote_file=t.length>0?t:[]),e=="ai_message"){if(t.menu_json&&t.msg_type==2){let n=JSON.parse(t.menu_json);i.value[a].question=n.question}i.value[a].id=t.id,i.value[a].content=t.content,t.quote_file&&typeof t.quote_file=="string"&&(i.value[a].quote_file=JSON.parse(t.quote_file))}e=="debug"&&(i.value[a].debug=t.length>0?t:[]),e=="error"&&(i.value[a].error=t.length>0?t:[]),e=="recall_time"&&(i.value[a].recall_time=t||0),e=="request_time"&&(i.value[a].request_time=t||0),e=="guess_you_want"&&(i.value=i.value.map(n=>({...n,question_tabkey:-1,guess_you_want:[]})),i.value[a].guess_you_want=t,i.value[a].question_tabkey=t.length>0?1:2),e=="set_question_tabkey"&&(i.value=i.value.map(n=>({...n,question_tabkey:-1})),i.value[a].question_tabkey=t),q.emit("updateAiMessage",i.value[a])},P=()=>{let e=i.value.length-1;i.value[e].loading=!1},m=v(!1),I=e=>{if(m.value)return;let t={loading:!0,id:"",content:"",reasoning_content:"",uid:g(32),robot_avatar:o.robot_avatar,msg_type:1,quote_file:[],debug:[],error:"",recall_time:"",request_time:"",show_reasoning:!1,reasoning_status:!1},u={robot_key:o.robot_key,openid:o.openid,question:e.message,form_ids:o.form_ids,dialogue_id:l.value};m.value=!0,c=Q(u),c.onMessage=a=>{if(a.event,a.event=="dialogue_id"&&(l.value=a.data),a.event=="c_message"){let n=JSON.parse(a.data);O(n)}if(a.event=="robot"&&(A(t),b.value&&(z(),b.value=!1)),a.event=="reasoning_content"&&d("reasoning_content",a.data,t.uid),a.event=="sending"&&d("sending",a.data,t.uid),a.event=="ai_message"){let n=JSON.parse(a.data);d("ai_message",n,t.uid)}if(a.event=="quote_file"){let n=JSON.parse(a.data);d("quote_file",n,t.uid)}if(a.event=="debug"){let n=JSON.parse(a.data);d("debug",n,t.uid)}if(a.event=="error"){let n=a.data;d("error",n,t.uid)}if(a.event=="recall_time"){let n=a.data;d("recall_time",n,t.uid)}if(a.event=="request_time"){let n=a.data;d("request_time",n,t.uid)}a.event=="finish"&&(o.enable_question_guide?X({robot_key:o.robot_key,openid:o.openid,dialogue_id:l.value}).then(n=>{d("guess_you_want",n.data||[],t.uid)}):d("set_question_tabkey",2,t.uid))},c.onClose=()=>{P(),m.value=!1,c=null}},R=25,f=v([]),y=v(!1),k=v(!1),x=async()=>{if(k.value||y.value)return!1;let e=0;f.value.length>0&&(e=f.value[f.value.length-1].id),y.value=!0;const t=await w({min_id:e,size:R,robot_key:o.robot_key});y.value=!1;const u=t.data||[];return u.length===0?(k.value=!0,!1):(f.value=[...f.value,...u],t)},z=()=>{w({min_id:0,size:1,robot_key:o.robot_key}).then(e=>{const t=e.data||[];t[0]&&f.value.unshift(t[0])})},E=async e=>await S(e),W=20,p=v(!1),T=async()=>{if(p.value)return;let e=0,t=i.value.filter(a=>!a.isWelcome);t.length>0&&(e=t[0].id);let u={robot_key:o.robot_key,openid:s.openid,min_id:e,size:W,dialogue_id:l.value};try{const a=await Y(u),n=a.data.list||[],F=a.data.robot;if(n.length===0){p.value=!0;return}return n.sort((r,V)=>r.id-V.id),n.forEach(r=>{r.loading=!1,r.uid=g(32),r.is_customer==1?r.avatar=s.avatar:r.robot_avatar=o.robot_avatar||F.robot_avatar,r.menu_json&&(r.menu_json=JSON.parse(r.menu_json)),r.quote_file&&(r.quote_file=JSON.parse(r.quote_file))}),i.value=[...n,...i.value],a}catch(a){Promise.reject(a)}},U=async e=>{try{const t=await Z(e);return t||Promise.reject(t)}catch(t){Promise.reject(t)}},D=async()=>{try{const e=await ee();return e||Promise.reject(e)}catch(e){Promise.reject(e)}},G=e=>{o.prompt=e},$=()=>ae({id:o.id,prompt:o.prompt});function B(){h.close(),l.value=0,i.value=[],_.value="",s.admin_user_id="",s.avatar="",s.id="",s.name="",s.nickname="",s.openid="",o.id="",o.library_ids="",o.form_ids="",o.prompt="",o.robot_avatar="",o.robot_intro="",o.robot_key="",o.robot_name="",o.openid="",o.welcomes={content:"",question:[]},b.value=!1,p.value=!1,m.value=!1,y.value=!1,k.value=!1,f.value=[]}return{$reset:B,user:s,robot:o,dialogue_id:l,openid:_,sendLock:m,messageList:i,createChat:S,createMsg:C,sendMessage:I,getMyChatList:x,myChatList:f,openChat:E,onGetChatMessage:T,changeRobotPrompt:G,saveRobotPrompt:$,getRecordList:U,getChannelList:D}});export{le as u};
