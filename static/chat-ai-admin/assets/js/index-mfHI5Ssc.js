import{J as ne,L as n,M as l,j as w,W as ce,V as a,S as K,X as z,Y as p,a8 as U,r as S,v as Z,y as H,B as ee,u as L,P as O,F as x,_ as I,a5 as P,a6 as R,a0 as E,a1 as V,w as le,Q as N,H as te,a9 as X,a3 as re,ah as de,E as ue}from"./vue-chunks-Be7x44a8.js";import{u as se,a as _e,_ as he}from"./useIM-pgdlM0Av.js";import{g as pe}from"./index-DoA-1VYy.js";import{ci as W,f as me,cX as Y,a1 as G,b as B,d as Q,b4 as ve}from"../../index-DrRzkLrM.js";import{B as A,M as fe,S as ge,P as ye}from"./pull-up.esm-JZ91zQ8P.js";import{O as be}from"./observe-dom.esm-DPKTicVt.js";import{S as Le}from"./index-CpDQkIaf.js";import{a as ke}from"./index-CTxSUaSW.js";import{_ as Se}from"./index-C-In0Yoq.js";import{_ as Te,S as $e}from"./index-olzhrUzL.js";import"./index-B3BARGoX.js";import"./axios-Cm0UX6qg.js";import"./qs-DBZYvUeR.js";import"./crypto-js-5KTNdlTg.js";import"./dayjs-B2GD4xRt.js";import"./Trigger-QcvDPnyC.js";import"./statusUtils-BM8Tk6m7.js";import"./slide-C3j77thT.js";import"./index-BFFBEz-T.js";import"./CheckOutlined-CoztOWtC.js";import"./DownOutlined-Cp0vVtPD.js";import"./SearchOutlined-CH2PxTj7.js";import"./FormItemContext-DlzjcwaL.js";import"./move-D51iXHK1.js";const Ce=(o={})=>W.get({url:"/manage/getReceiverList",params:o}),we=(o={})=>W.post({url:"/chat/message",data:o}),Re=(o={})=>W.post({url:"/manage/setReceiverRead",data:o}),F=ne("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const o=_e(),s=me();this.im=o,o.connect(s.user_id),o.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(o){if(!this.activeChat)return;const s=se();let e=o.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=Y(e.create_time),e.uid=G(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),s.emit("onAddMessage",e))},onAddReceiver(o){let s=o.data;s.displayName=s.name||s.nickname,s.come_from=JSON.parse(s.come_from);let e=this.receiverList.find(c=>c.session_id==s.session_id);e?Object.assign(e,s):(this.selectedRobotId==""||this.selectedRobotId==s.robot_id)&&this.receiverList.unshift(s)},onDeleteReceiver(o){let s=o.data,e=this.receiverList.findIndex(c=>c.id==s);e!=-1&&(this.activeChat&&this.activeChat.id==s&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(o){return pe(o).then(s=>(this.robotList=s.data||[],s))},async getReceiverList(){return this.receiverListPage.page++,Ce({...this.receiverListPage,robot_id:this.selectedRobotId}).then(o=>{let s=o.data.list||[];for(let e=0;e<s.length;e++)s[e].displayName=s[e].name||s[e].nickname,s[e].come_from&&(s[e].come_from=JSON.parse(s[e].come_from));return this.receiverListPage.page==1?this.receiverList=s:this.receiverList=this.receiverList.concat(s),o})},changeRobot(){this.activeChat=null,this.resetReceiverList()},resetReceiverList(){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList()},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let o=0,s=this.messageList.filter(c=>!c.isWelcome);s.length>0&&(o=s[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:o,size:this.chatMessagePageSize};return we(e).then(c=>{var g,_;this.messageListLoading=!1;let t=c.data.list||[];const d=((g=c==null?void 0:c.data)==null?void 0:g.customer)||{},m=((_=c==null?void 0:c.data)==null?void 0:_.robot)||{};t.sort((i,v)=>i.id-v.id);for(let i=0;i<t.length;i++)t[i].displayName=t[i].name||t[i].nickname,t[i].is_customer==1?(t[i].displayName=t[i].displayName||d.name,t[i].avatar=t[i].avatar||d.avatar):(t[i].displayName=t[i].displayName||m.robot_name,t[i].avatar=t[i].avatar||m.robot_avatar),t[i].uid=G(32),t[i].menu_json&&typeof t[i].menu_json=="string"&&(t[i].menu_json=JSON.parse(t[i].menu_json)),t[i].quote_file&&typeof t[i].menu_json=="string"&&(t[i].quote_file=JSON.parse(t[i].quote_file)),t[i].dispayTime=Y(t[i].create_time);return this.messageList=[...t,...this.messageList],t.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),c}).catch(c=>{this.messageListLoading=!1})},claerUnread(){return Re({id:this.selectedReceiverId})},async switchChat(o){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=o.id,this.activeChat=o,this.claerUnread(),await this.getChatMessage()}}}),Me={class:"no-data"},xe={class:"no-data-text"},Ie={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(o){const s=o;return(e,c)=>{const t=Q;return n(),l("div",Me,[w(t,{name:"empty",style:ce({"font-size":`${s.size}px`})},null,8,["style"]),a("div",xe,[K(e.$slots,"default",{},()=>[z(p(s.text),1)],!0)])])}}},oe=B(Ie,[["__scopeId","data-v-9f7736f0"]]),Ne=o=>(E("data-v-1ec2dca0"),o=o(),V(),o),Be={key:1,class:"chat-list"},De=["onClick"],Oe={class:"avatar"},je=["src","alt"],qe={class:"chat-info"},Ae={class:"nickname"},ze={class:"last-message"},He={class:"webapp-source"},Pe={key:0,class:"loading-wrapper"},Ue=Ne(()=>a("span",{class:"loading-text"},"加载中...",-1)),Fe={key:1,class:"finished-text"},Je={__name:"chat-list ",emits:["switchChat"],setup(o,{emit:s}){A.use(fe),A.use(ge),A.use(be),A.use(ye);const e=s,c=F(),{getReceiverList:t}=c,{receiverList:d,selectedReceiverId:m}=U(c),g=S(null);let _=null;const i=S(!1),v=S(!1),T=()=>{_=new A(g.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),_.on("pullingUp",()=>{M()})},M=async()=>{if(i.value||v.value){_.finishPullUp();return}i.value=!0;try{(await t()).data.list.length===0&&(v.value=!0)}catch(r){console.error("加载更多数据失败:",r)}finally{i.value=!1,_.finishPullUp(),_.refresh()}},f=r=>{e("switchChat",r)};return Z(()=>{H(()=>{T()})}),ee(()=>{_&&_.destroy()}),(r,b)=>{const $=Le;return n(),l("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:g},[L(d).length==0?(n(),O(oe,{key:0,size:"140",text:"暂无机器人接待中会话"})):(n(),l("div",Be,[(n(!0),l(x,null,I(L(d),y=>(n(),l("div",{key:y.id,class:P(["chat-item",{active:y.id===L(m)}]),onClick:u=>f(y)},[a("div",Oe,[a("img",{src:y.avatar,alt:y.displayName},null,8,je),y.unread>0?(n(),l("span",{key:0,class:P(["dot",{plus:y.unread>9}])},p(y.unread),3)):R("",!0)]),a("div",qe,[a("div",Ae,p(y.displayName),1),a("div",ze,p(y.last_chat_message),1),a("div",He,"来自："+p(y.come_from.app_name),1)])],10,De))),128)),i.value?(n(),l("div",Pe,[w($,{size:"small"}),Ue])):R("",!0),v.value?(n(),l("div",Fe,"没有更多了")):R("",!0)]))],512)}}},Ee=B(Je,[["__scopeId","data-v-1ec2dca0"]]),Ve={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(o,{expose:s,emit:e}){const c=o,t=e,d=S(null),m=S({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:c.topTriggerDistance,scrollEndDiff:c.bottomTriggerDistance}),g=S(null),_=r=>{const{scrollTop:b}=r,$=m.value.scrollTop-b;m.value.scrollDirection=$>0?"up":"down",Object.assign(m.value,{scrollTop:b,scrollHeight:r.scrollHeight,clientHeight:r.clientHeight})},i=()=>{const{scrollTop:r,scrollHeight:b,clientHeight:$,scrollStartDiff:y,scrollEndDiff:u,scrollDirection:C}=m.value;t("scroll",{...m.value}),c.isLoading||(Math.abs(r)<=y&&C==="up"&&t("scroll-top",{...m.value}),Math.abs(b-r-$)<=u&&C==="down"&&t("scroll-bottom",{...m.value}))},v=r=>{_(r.target),g.value&&(clearTimeout(g.value),g.value=null),g.value=setTimeout(()=>{i()},100)};function T(){d.value&&(d.value.scrollTop=0)}function M(){d.value&&(d.value.scrollTop=d.value.scrollHeight)}function f(){return d.value&&Object.assign(m.value,{scrollTop:d.value.scrollTop,scrollHeight:d.value.scrollHeight,clientHeight:d.value.clientHeight}),JSON.parse(JSON.stringify(m.value))}return le(()=>c.scrollTop,r=>{d.value&&(d.value.scrollTop=r)}),s({scrollToTop:T,scrollToBottom:M,getState:f}),(r,b)=>(n(),l("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:d,onScroll:v},[K(r.$slots,"default",{},void 0,!0)],544))}},We=B(Ve,[["__scopeId","data-v-3e3a1c2e"]]),ae=o=>(E("data-v-97ee52a0"),o=o(),V(),o),Qe={class:"chat-message-warpper"},Xe={class:"chat-message-content"},Ye={key:0,class:"is-loaded"},Ge={class:"avatar"},Ke=["src","alt"],Ze={class:"message-content"},et={class:"message-info"},tt={class:"nickname"},st=ae(()=>a("i",{class:"gap"},null,-1)),ot={class:"time"},at={class:"message-bubble"},it={key:0,class:"text-content"},nt={key:1},ct={key:1,class:"image-content"},lt=["src"],rt={key:2,class:"menu-content"},dt={class:"menus-label"},ut={key:0,class:"menu-items"},_t=["onClick"],ht={key:3,class:"answer-reference-box"},pt=ae(()=>a("div",{class:"answer-reference-label"},"回答参考",-1)),mt=["onClick"],vt={__name:"chat-message",emits:["openLibrary"],setup(o,{expose:s,emit:e}){const c=e,t=S(null),d=F(),{getChatMessage:m}=d,{messageList:g,messageListScrollTop:_,messageListLoading:i,chatMessageLoadCompleted:v,activeChat:T}=U(d),M=()=>{};function f(C,k,j){let h=X(C);k.robot_key=T.value.robot_key,k.robot_id=T.value.robot_id,h.forEach(D=>{D.message_id=j.id,D.openid=j.openid,D.robot_key=T.value.robot_key,D.robot_id=T.value.robot_id}),c("openLibrary",h,X(k))}const r=C=>{const{scrollTop:k}=C;_.value=k},b=async()=>{if(v.value)return;let C=t.value.getState();await m(),H(()=>{let k=t.value.getState();k.scrollDirection=="up"&&(_.value=k.scrollHeight-C.scrollHeight)})},$=async()=>{};return s({scrollToTop:()=>{t.value.scrollToTop()},scrollToBottom:()=>{t.value.scrollToBottom()}}),(C,k)=>{const j=Q;return n(),l("div",Qe,[w(We,{ref_key:"scrollViewRef",ref:t,scrollTop:L(_),"onUpdate:scrollTop":k[0]||(k[0]=h=>te(_)?_.value=h:null),"is-loading":L(i),onScroll:r,onScrollTop:b,onScrollBottom:$},{default:N(()=>[a("div",Xe,[L(v)?(n(),l("div",Ye,"没用更多聊天记录了")):R("",!0),(n(!0),l(x,null,I(L(g),(h,D)=>(n(),l("div",{key:D,class:P(["message-item",h.is_customer==0?"right":""])},[a("div",Ge,[a("img",{src:h.avatar,alt:h.displayName},null,8,Ke)]),a("div",Ze,[a("div",et,[a("span",tt,p(h.displayName),1),st,a("span",ot,p(h.dispayTime),1)]),a("div",at,[h.msg_type==1?(n(),l("div",it,[h.is_customer==0?(n(),O(he,{key:0,content:h.content},null,8,["content"])):(n(),l("div",nt,p(h.content),1))])):h.msg_type==3?(n(),l("div",ct,[a("img",{src:h.content,alt:"image"},null,8,lt)])):h.msg_type==2?(n(),l("div",rt,[a("div",dt,p(h.menu_json.content),1),h.menu_json.question&&h.menu_json.question.length>0?(n(),l("div",ut,[(n(!0),l(x,null,I(h.menu_json.question,(q,J)=>(n(),l("div",{key:J,class:"menu-item",onClick:ie=>M(q)},p(q),9,_t))),128))])):R("",!0)])):R("",!0),h.quote_file&&h.quote_file.length?(n(),l("div",ht,[pt,a("div",null,[(n(!0),l(x,null,I(h.quote_file,(q,J)=>(n(),l("div",{class:"list-item",key:J},[w(j,{name:"attachment"}),a("span",{onClick:ie=>f(h.quote_file,q,h)},p(q.file_name),9,mt)]))),128))])])):R("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},ft=B(vt,[["__scopeId","data-v-97ee52a0"]]),gt={class:"library-info-content"},yt={class:"file-list"},bt=["onClick"],Lt={class:"document-items"},kt={class:"document-item-header"},St={class:"left-box"},Tt={class:"document-title"},$t={key:0,class:"document-title"},Ct={class:"document-size"},wt={class:"document-item-body"},Rt={class:"document-similarity"},Mt={key:0,class:"document-content"},xt={key:1,class:"document-content"},It={class:"document-content"},Nt={class:"fragment-img"},Bt=["src"],Dt={__name:"library-info-alert",setup(o,{expose:s}){const e=re(),c=S(!1),t=S([]),d=S(null),m=()=>{t.value=[],d.value=null},g=(f,r)=>{m(),t.value=f,d.value=r.id,c.value=!0,v(r)},_=f=>{f.id!=d.value&&(d.value=f.id,v(f))},i=S([]),v=f=>{ke({message_id:f.message_id,file_id:f.id,robot_key:f.robot_key,openid:f.openid}).then(r=>{i.value=r.data||[]})},T=()=>{e.push("/library/preview?id="+d.value)},M=()=>{c.value=!1};return s({open:g}),(f,r)=>{const b=Q,$=Se,y=de("viewer");return n(),O($,{class:"library-info-alert",open:c.value,"onUpdate:open":r[0]||(r[0]=u=>c.value=u),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:N(()=>[a("span",{class:"close-btn",onClick:M},[w(L(ve))])]),default:N(()=>[a("div",gt,[a("div",yt,[(n(!0),l(x,null,I(t.value,u=>(n(),l("div",{class:P(["file-item",{active:d.value==u.id}]),key:u.id,onClick:C=>_(u)},p(u.file_name),11,bt))),128))]),a("div",Lt,[(n(!0),l(x,null,I(i.value,u=>(n(),l("div",{class:"document-item",key:u.id},[a("div",kt,[a("div",St,[a("span",Tt,"id："+p(u.id),1),u.title?(n(),l("span",$t,p(u.title),1)):R("",!0),a("span",Ct," 共"+p(u.word_total)+"个字符 ",1)]),a("div",{class:"right-box"},[a("a",{onClick:T},"查看源文档>")])]),a("div",wt,[a("div",Rt,[z(" 相似度： "),w(b,{name:"similarity",style:{"font-size":"16px"}}),z(p(u.similarity),1)]),u.question?(n(),l("div",Mt,"Q："+p(u.question),1)):R("",!0),u.answer?(n(),l("div",xt,"A："+p(u.answer),1)):R("",!0),a("div",It,p(u.content),1),ue((n(),l("div",Nt,[(n(!0),l(x,null,I(u.images,(C,k)=>(n(),l("img",{key:k,src:C,alt:""},null,8,Bt))),128))])),[[y]])])]))),128))])])]),_:1},8,["open"])}}},Ot=B(Dt,[["__scopeId","data-v-3e30a1b1"]]),jt={key:0,class:"chat-box-warpper"},qt={class:"chat-box-header"},At={class:"nickname"},zt={class:"chat-source"},Ht={class:"chat-box-content"},Pt={key:1},Ut={__name:"chat-box",setup(o,{expose:s}){const e=F(),{activeChat:c}=U(e),t=S(null),d=()=>{t.value.scrollToBottom()},m=()=>{t.value.scrollToTop()},g=S(null),_=(i,v)=>{g.value.open(i,v)};return s({scrollToTop:m,scrollToBottom:d}),(i,v)=>(n(),l(x,null,[L(c)?(n(),l("div",jt,[a("div",qt,[a("div",At,p(L(c).name||L(c).nickname),1),a("div",zt," 来自："+p(L(c).come_from.robot_name)+" - "+p(L(c).come_from.app_name),1)]),a("div",Ht,[w(ft,{ref_key:"chatMessageRef",ref:t,onOpenLibrary:_},null,512)])])):(n(),l("div",Pt)),w(Ot,{ref_key:"libraryInfoAlertRef",ref:g},null,512)],64))}},Ft=B(Ut,[["__scopeId","data-v-1d47d849"]]),Jt=o=>(E("data-v-c1c7a4c3"),o=o(),V(),o),Et={class:"chat-monitor-page"},Vt={class:"page-left"},Wt={class:"app-list-box"},Qt={class:"chat-list-wrapper"},Xt={class:"page-body"},Yt=Jt(()=>a("div",null,[a("p",null,"请在左侧列表先选择会话"),a("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)),Gt={__name:"index",setup(o){const s=se(),e=F(),{init:c,changeRobot:t,switchChat:d,closeIM:m}=e,{robotList:g,selectedRobotId:_,activeChat:i}=U(e),v=S(null),T=()=>{t()},M=async r=>{var b;await d(r),(b=v.value)==null||b.scrollToBottom()},f=()=>{H(()=>{var r;(r=v.value)==null||r.scrollToBottom()})};return Z(async()=>{await c(),H(()=>{var r;(r=v.value)==null||r.scrollToBottom()}),s.on("onAddMessage",f)}),ee(()=>{s.off("onAddMessage",f),m()}),(r,b)=>{const $=$e,y=Te;return n(),l("div",Et,[a("div",Vt,[a("div",Wt,[w(y,{value:L(_),"onUpdate:value":b[0]||(b[0]=u=>te(_)?_.value=u:null),style:{width:"100%"},onChange:T},{default:N(()=>[w($,{value:""},{default:N(()=>[z("全部应用")]),_:1}),(n(!0),l(x,null,I(L(g),u=>(n(),O($,{value:u.id,key:u.id},{default:N(()=>[a("span",null,p(u.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),a("div",Qt,[w(Ee,{onSwitchChat:M})])]),a("div",Xt,[L(i)?(n(),O(Ft,{key:0,ref_key:"chatBoxRef",ref:v},null,512)):(n(),O(oe,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:N(()=>[Yt]),_:1}))])])}}},ks=B(Gt,[["__scopeId","data-v-c1c7a4c3"]]);export{ks as default};
