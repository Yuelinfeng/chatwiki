import{_ as fe,e as M,bm as ve,bp as ye,Y as ge,U as he,Z as be,c as ke,B as xe}from"../../index-CWYf_R7c.js";import{$ as Ne,a0 as qe,b as P,r as y,A as R,v as we,L as _,M as f,V as u,j as l,Q as r,U as k,u as x,F as w,a1 as S,a2 as O,Y as g,P as A,a6 as N,E as B,G as L,X as v,a8 as Ae,a3 as Ce,a4 as Se}from"./vue-chunks-Bxyh5WP6.js";import{U as Be}from"./upload-input-C4tXEEhx.js";import{c as Le}from"./index-Do3gHCO_.js";import{c as Ee}from"./index-DFKCqvOx.js";import{A as Ue}from"./avatar-input-BhwtBRXY.js";import{t as $}from"./validate-8MtiUsxW.js";import{F as z,_ as Ve}from"./index-Cm_NtOSH.js";import"./index-mQw8zXXP.js";import{I as Fe}from"./Input-BW-N7Cx9.js";import"./index-Dsf1d2yx.js";import{R as Te,_ as De}from"./RadioButton-B3MvGE55.js";import{_ as Ie}from"./TextArea-C1_B5Wm2.js";import{S as Me,_ as Pe,a as Re}from"./index-BLHGs8uC.js";import{_ as Oe}from"./index-DxeJG8dU.js";import"./axios-Cm0UX6qg.js";import"./qs-CEiBKtbM.js";import"./crypto-js-C0fK7Mgg.js";import"./dayjs-BgtA0fgD.js";import"./InboxOutlined-CdIAK4GV.js";import"./index-D70JqhWj.js";import"./partition-Dd7XR8Em.js";import"./Trigger-DXFMCREP.js";import"./Password-BrrLsfMb.js";import"./inputProps-CuDRpClH.js";import"./index-C1M6HpEG.js";import"./colors-CmI3I2v0.js";import"./CheckOutlined-DAabT47N.js";import"./useRefs-DgEUwJAf.js";import"./collapseMotion-DDsixTll.js";import"./FormItemContext-CY3sS3S3.js";import"./PlusOutlined-Cu0dwBBw.js";import"./isPlainObject-Q-ndSLdg.js";import"./responsiveObserve-BtDP6tEg.js";import"./QuestionCircleOutlined-BggeZNYy.js";import"./index-BYiIgJN3.js";import"./Search-C52Nu70G.js";import"./SearchOutlined-gkqcN_Zr.js";import"./statusUtils-D2ojHtZY.js";import"./index-C_rHdEod.js";import"./slide-BHEoaamw.js";import"./isMobile-D_4OiXLP.js";import"./DownOutlined-BawL_eGx.js";import"./move-DtLl1qq4.js";const $e=C=>(Ce("data-v-a55c4b2b"),C=C(),Se(),C),ze={class:"add-library-page"},je={class:"form-box"},Ye=$e(()=>u("div",{class:"form-item-tip"},"请上传知识库封面，建议尺寸为100*100px.大小不超过100kb",-1)),Ge={class:"upload-document-type-box"},Je=["onClick"],Qe={class:"right-block"},Xe={class:"title-block"},Ze={class:"title-text"},He={class:"desc"},Ke={class:"upload-document-type-box"},We=["onClick"],ea={class:"right-block"},aa={class:"title-block"},oa={class:"title-text"},ta={class:"desc"};const la=["src"],na={key:0},ia={key:1},ra={__name:"add-library",setup(C){const{getStorage:j,setStorage:Y,removeStorage:sa}=he("localStorage");M.config({duration:2});const E=Ne(),G=qe(),s=P(()=>G.query.type||0),U=["azure","ollama","xinference","openaiAgent"],J=["azure"],da=y([{iconName:"high",iconNameActive:"high-active",title:"高质量",value:1,is_offline:!1,desc:"使用在线的嵌入模型，在召回时具有更高的准确度，但需要花费token"}]),V=y([{iconName:"doc-icon",iconNameActive:"doc-icon-active",title:"本地文档",value:1,desc:`${s.value==2?"上传本地 docx/csv/xlsx 等格式文件":"上传本地 pdf/docx/ofd/txt/md/xlsx/csv/html 等格式文件"}`},{iconName:"link-icon",iconNameActive:"link-icon-active",title:"在线数据",value:2,desc:"获取在线网页内容"},{iconName:"cu-doc-icon",iconNameActive:"cu-doc-active",title:"自定义文档",value:3,desc:"自定义一个空文档，手动添加或编辑内容"}]);s.value==2&&(V.value=V.value.filter(a=>a.value!=2));const Q=y([{iconName:"file-search",iconNameActive:"file-search",title:"问题与答案一起生成索引",value:1,desc:"回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复"},{iconName:"comment-search",iconNameActive:"comment-search",title:"仅对问题生成索引",value:2,desc:"回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复"}]),X=z.useForm,q=y(!1),Z=P(()=>j("lastEmbeddedModel")||{}),H=y(1),K=s.value==0?ve:ye,e=R({type:s.value,access_rights:0,library_name:"",library_intro:"",use_model:"text-embedding-v2",model_config_id:"",library_files:void 0,avatar:K,avatar_file:void 0,is_offline:!1,urls:"",doc_type:1,file_name:"",is_qa_doc:s.value==2?1:0,qa_index_type:1,doc_auto_renew_frequency:1}),F=y(""),W=(a,t)=>s.value==1||t&&t.length>0||e.doc_type!=1?Promise.resolve():Promise.reject(new Error("请上传文件")),ee=(a,t)=>s.value==1||e.doc_type!=2?Promise.resolve():$(t)===!1?Promise.reject(new Error("网页地址不合法")):Promise.resolve(),ae=R({library_name:[{required:!0,message:"请输入库名称",trigger:"change"}],use_model:[{required:!0,message:"请选择嵌入模型",trigger:"change"}],library_files:[{required:s.value==0,message:"请选择文件",trigger:"change",validator:W}],urls:[{required:s.value==0,validator:ee}],file_name:[{required:s.value==0,validator:(a,t)=>s.value==1||e.doc_type!=3||t?Promise.resolve():Promise.reject(new Error("请输入文档名称"))}]}),{validate:oe,validateInfos:h}=X(e,ae),te=a=>{e.library_files=a},le=(a,t)=>{const d=t.current_obj;e.use_model=U.indexOf(d.model_define)>-1&&d.deployment_name?d.deployment_name:d.name,F.value=d.model_define,e.model_config_id=d.id||t.model_config_id},ne=a=>{e.avatar=a.imageUrl,e.avatar_file=a.file},ca=a=>{e.is_offline=a.is_offline,H.value=a.value,e.use_model=void 0,T(a.is_offline)},ie=a=>{e.doc_type=a},re=a=>{e.qa_index_type=a},se=()=>{E.back()},de=()=>{oe().then(()=>{ce()}).catch(a=>{})},ce=()=>{let a=new FormData,t=JSON.parse(JSON.stringify(e));J.indexOf(F.value)>-1&&(t.use_model="默认"),a.append("type",e.type),a.append("access_rights",e.access_rights),a.append("library_name",e.library_name),a.append("library_intro",e.library_intro),a.append("use_model",t.use_model),a.append("model_config_id",e.model_config_id),a.append("avatar",e.avatar_file?e.avatar_file:""),a.append("is_offline",e.is_offline),a.append("urls",JSON.stringify($(e.urls))),a.append("doc_type",e.doc_type),a.append("file_name",e.file_name),a.append("is_qa_doc",e.is_qa_doc),a.append("qa_index_type",e.qa_index_type),a.append("doc_auto_renew_frequency",e.doc_auto_renew_frequency),Y("lastEmbeddedModel",{});let d=!1;(s.value==0||s.value==2)&&e.doc_type==1&&e.library_files.forEach(n=>{(n.name.includes(".xlsx")||n.name.includes(".csv"))&&(d=!0),a.append("library_files",n)}),q.value=!0,Le(a).then(n=>{if(M.success("创建成功"),s.value==1){E.replace({path:"/public-library/config",query:{library_id:n.data.id}}),q.value=!1;return}let i="/library/details/knowledge-document",c={id:n.data.id};d&&(i="/library/document-segmentation",c={document_id:n.data.file_ids[0]}),e.doc_type==3&&(i="/library/preview",c={id:n.data.file_ids[0]}),E.replace({path:i,query:c}),q.value=!1}).catch(()=>{q.value=!1})},b=y([]);function _e(a,t,d){const n=new Set(a.map(i=>i.model_define));return t.filter(i=>{let c=i[d];n.has(c)&&a.filter(p=>{if(p.model_define==c)return p.children=be(p.children,i.children),!1})}),a}const T=a=>{Ee({model_type:"TEXT EMBEDDING",is_offline:a}).then(t=>{let d=t.data||[],n=[];b.value=d.map(i=>{n=[];for(let c=0;c<i.model_info.vector_model_list.length;c++){const p=i.model_info.vector_model_list[c];n.push({name:p,deployment_name:i.model_config.deployment_name,id:i.model_config.id,model_define:i.model_info.model_define})}return i.model_config.id==Z.value.model_config_id,{id:i.model_config.id,name:i.model_info.model_name,model_define:i.model_info.model_define,icon:i.model_info.model_icon_url,children:n,deployment_name:i.model_config.deployment_name}}),b.value=_e(ge(b.value,"model_define"),b.value,"model_define"),b.value.forEach(i=>{i.model_define=="chatwiki"&&(e.model_config_id=i.id)})})};return we(()=>{T(!1)}),(a,t)=>{const d=Fe,n=Ve,i=Ie,c=ke,p=Me,D=Pe,_a=Te,ua=De,ue=Oe,me=Re,I=xe,pe=z;return _(),f("div",ze,[u("div",je,[l(pe,{"label-col":{span:5}},{default:r(()=>[l(n,k({ref:"name",label:"知识库名称"},x(h).library_name),{default:r(()=>[l(d,{value:e.library_name,"onUpdate:value":t[0]||(t[0]=o=>e.library_name=o),type:"text",placeholder:"请输入知识库名称，最多20个字",maxlength:20},null,8,["value"])]),_:1},16),l(n,{label:"知识库简介"},{default:r(()=>[l(i,{value:e.library_intro,"onUpdate:value":t[1]||(t[1]=o=>e.library_intro=o),placeholder:"请输入知识库介绍"},null,8,["value"])]),_:1}),l(n,k({ref:"name",label:"知识库封面"},x(h).avatar),{default:r(()=>[l(Ue,{value:e.avatar,"onUpdate:value":t[2]||(t[2]=o=>e.avatar=o),onChange:ne},null,8,["value"]),Ye]),_:1},16),s.value!=1?(_(),f(w,{key:0},[l(n,{label:"导入文档类型",required:""},{default:r(()=>[u("div",Ge,[(_(!0),f(w,null,S(V.value,o=>(_(),f("div",{class:O(["type-item",{active:e.doc_type==o.value}]),key:o.value,onClick:m=>ie(o.value)},[u("div",Qe,[u("div",Xe,[l(c,{name:e.doc_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),u("div",Ze,g(o.title),1)]),u("div",He,g(o.desc),1)]),e.doc_type==o.value?(_(),A(c,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):N("",!0)],10,Je))),128))])]),_:1}),B(l(n,k({ref:"name",label:"知识库文档"},x(h).library_files),{default:r(()=>[l(Be,{type:s.value,onChange:te},null,8,["type"])]),_:1},16),[[L,e.doc_type==1]]),B(l(n,k({ref:"urls",label:"网页链接"},x(h).urls),{default:r(()=>[l(i,{style:{height:"120px"},value:e.urls,"onUpdate:value":t[3]||(t[3]=o=>e.urls=o),placeholder:"请输入网页链接,形式：一行标题一行网页链接"},null,8,["value"])]),_:1},16),[[L,e.doc_type==2]]),B(l(n,{ref:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:r(()=>[l(D,{value:e.doc_auto_renew_frequency,"onUpdate:value":t[4]||(t[4]=o=>e.doc_auto_renew_frequency=o),style:{width:"100%"}},{default:r(()=>[l(p,{value:1},{default:r(()=>[v("不自动更新")]),_:1}),l(p,{value:2},{default:r(()=>[v("每天")]),_:1}),l(p,{value:3},{default:r(()=>[v("每3天")]),_:1}),l(p,{value:4},{default:r(()=>[v("每7天")]),_:1}),l(p,{value:5},{default:r(()=>[v("每30天")]),_:1})]),_:1},8,["value"])]),_:1},512),[[L,e.doc_type==2]]),B(u("div",null,[l(n,k({ref:"file_name",label:"文档名称"},x(h).file_name),{default:r(()=>[l(d,{placeholder:"请输入文档名称",value:e.file_name,"onUpdate:value":t[5]||(t[5]=o=>e.file_name=o)},null,8,["value"])]),_:1},16),N("",!0),e.is_qa_doc==1?(_(),A(n,{key:1,label:"索引方式",required:""},{default:r(()=>[u("div",Ke,[(_(!0),f(w,null,S(Q.value,o=>(_(),f("div",{class:O(["type-item",{active:e.qa_index_type==o.value}]),key:o.value,onClick:m=>re(o.value)},[u("div",ea,[u("div",aa,[l(c,{name:e.qa_index_type==o.value?o.iconNameActive:o.iconName},null,8,["name"]),u("div",oa,g(o.title),1)]),u("div",ta,g(o.desc),1)]),e.qa_index_type==o.value?(_(),A(c,{key:0,class:"check-arrow",name:"check-arrow-filled",style:{"font-size":"24px",color:"#fff"}})):N("",!0)],10,We))),128))])]),_:1})):N("",!0)],512),[[L,e.doc_type==3]])],64)):N("",!0),l(n,k({label:"嵌入模型 "},x(h).use_model),{default:r(()=>[N("",!0),l(D,{value:e.use_model,"onUpdate:value":t[7]||(t[7]=o=>e.use_model=o),placeholder:"请选择嵌入模型",onChange:le},{default:r(()=>[(_(!0),f(w,null,S(b.value,o=>(_(),A(me,{key:o.id},{label:r(()=>[l(ue,{align:"center",gap:6},{default:r(()=>[u("img",{class:"model-icon",src:o.icon,alt:""},null,8,la),v(g(o.name),1)]),_:2},1024)]),default:r(()=>[(_(!0),f(w,null,S(o.children,m=>(_(),A(p,{value:U.indexOf(o.model_define)>-1&&m.deployment_name?m.deployment_name:m.name+m.id,model_config_id:o.id,current_obj:m,key:m.name+m.id},{default:r(()=>[U.indexOf(o.model_define)>-1&&m.deployment_name?(_(),f("span",na,g(m.deployment_name),1)):(_(),f("span",ia,g(m.name),1))]),_:2},1032,["value","model_config_id","current_obj"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},16),l(n,{"wrapper-col":{span:14,offset:4}},{default:r(()=>[l(I,{onClick:se},{default:r(()=>[v("取 消")]),_:1}),l(I,{type:"primary",style:{"margin-left":"16px"},loading:q.value,onClick:Ae(de,["prevent"])},{default:r(()=>[v("下一步")]),_:1},8,["loading"])]),_:1})]),_:1})])])}}},to=fe(ra,[["__scopeId","data-v-a55c4b2b"]]);export{to as default};
