import{J as ne,L as a,M as c,j as w,W as ce,V as i,S as K,X as z,Y as h,a7 as U,r as S,v as Z,y as H,B as ee,u as L,P as O,F as x,a1 as I,a2 as P,a6 as R,a3 as E,a4 as F,w as le,Q as B,H as te,a9 as Y,$ as re,ah as de,E as ue}from"./vue-chunks-Bxyh5WP6.js";import{u as se,a as _e,_ as he}from"./useIM-C-Li-ntS.js";import{g as pe}from"./index-xJ7lndAQ.js";import{cg as W,a as me,cV as X,$ as G,_ as D,c as Q,b2 as ve}from"../../index-CWYf_R7c.js";import{B as A,M as fe,S as ge,P as ye}from"./pull-up.esm-JZ91zQ8P.js";import{O as be}from"./observe-dom.esm-DPKTicVt.js";import{S as Le}from"./index-SLPzh8Tt.js";import{a as ke}from"./index-Vr5IbFke.js";import{_ as Se}from"./index-DoAV7BrM.js";import{_ as Te,S as $e}from"./index-BLHGs8uC.js";import"./index-DV-9vSKv.js";import"./axios-Cm0UX6qg.js";import"./qs-CEiBKtbM.js";import"./crypto-js-C0fK7Mgg.js";import"./dayjs-BgtA0fgD.js";import"./Trigger-DXFMCREP.js";import"./statusUtils-D2ojHtZY.js";import"./slide-BHEoaamw.js";import"./index-C_rHdEod.js";import"./isMobile-D_4OiXLP.js";import"./CheckOutlined-DAabT47N.js";import"./DownOutlined-BawL_eGx.js";import"./SearchOutlined-gkqcN_Zr.js";import"./FormItemContext-CY3sS3S3.js";import"./move-DtLl1qq4.js";const Ce=(o={})=>W.get({url:"/manage/getReceiverList",params:o}),we=(o={})=>W.post({url:"/chat/message",data:o}),Re=(o={})=>W.post({url:"/manage/setReceiverRead",data:o}),J=ne("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const o=_e(),t=me();this.im=o,o.connect(t.user_id),o.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(o){if(!this.activeChat)return;const t=se();let e=o.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=X(e.create_time),e.uid=G(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),t.emit("onAddMessage",e))},onAddReceiver(o){let t=o.data;t.displayName=t.name||t.nickname,t.come_from=JSON.parse(t.come_from);let e=this.receiverList.find(r=>r.session_id==t.session_id);e?Object.assign(e,t):(this.selectedRobotId==""||this.selectedRobotId==t.robot_id)&&this.receiverList.unshift(t)},onDeleteReceiver(o){let t=o.data,e=this.receiverList.findIndex(r=>r.id==t);e!=-1&&(this.activeChat&&this.activeChat.id==t&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(o){return pe(o).then(t=>(this.robotList=t.data||[],t))},async getReceiverList(){return this.receiverListPage.page++,Ce({...this.receiverListPage,robot_id:this.selectedRobotId}).then(o=>{let t=o.data.list||[];for(let e=0;e<t.length;e++)t[e].displayName=t[e].name||t[e].nickname,t[e].come_from&&(t[e].come_from=JSON.parse(t[e].come_from));return this.receiverListPage.page==1?this.receiverList=t:this.receiverList=this.receiverList.concat(t),o})},changeRobot(){this.activeChat=null,this.resetReceiverList()},resetReceiverList(){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList()},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let o=0,t=this.messageList.filter(r=>!r.isWelcome);t.length>0&&(o=t[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:o,size:this.chatMessagePageSize};return we(e).then(r=>{this.messageListLoading=!1;let n=r.data.list||[];n.sort((s,p)=>s.id-p.id);for(let s=0;s<n.length;s++)n[s].displayName=n[s].name||n[s].nickname,n[s].uid=G(32),n[s].menu_json&&typeof n[s].menu_json=="string"&&(n[s].menu_json=JSON.parse(n[s].menu_json)),n[s].quote_file&&typeof n[s].menu_json=="string"&&(n[s].quote_file=JSON.parse(n[s].quote_file)),n[s].dispayTime=X(n[s].create_time);return this.messageList=[...n,...this.messageList],n.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),r}).catch(r=>{this.messageListLoading=!1})},claerUnread(){return Re({id:this.selectedReceiverId})},async switchChat(o){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=o.id,this.activeChat=o,this.claerUnread(),await this.getChatMessage()}}}),Me={class:"no-data"},xe={class:"no-data-text"},Ie={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(o){const t=o;return(e,r)=>{const n=Q;return a(),c("div",Me,[w(n,{name:"empty",style:ce({"font-size":`${t.size}px`})},null,8,["style"]),i("div",xe,[K(e.$slots,"default",{},()=>[z(h(t.text),1)],!0)])])}}},oe=D(Ie,[["__scopeId","data-v-9f7736f0"]]),Be=o=>(E("data-v-1ec2dca0"),o=o(),F(),o),De={key:1,class:"chat-list"},Ne=["onClick"],Oe={class:"avatar"},je=["src","alt"],qe={class:"chat-info"},Ae={class:"nickname"},ze={class:"last-message"},He={class:"webapp-source"},Pe={key:0,class:"loading-wrapper"},Ue=Be(()=>i("span",{class:"loading-text"},"加载中...",-1)),Je={key:1,class:"finished-text"},Ve={__name:"chat-list ",emits:["switchChat"],setup(o,{emit:t}){A.use(fe),A.use(ge),A.use(be),A.use(ye);const e=t,r=J(),{getReceiverList:n}=r,{receiverList:s,selectedReceiverId:p}=U(r),g=S(null);let _=null;const y=S(!1),v=S(!1),T=()=>{_=new A(g.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),_.on("pullingUp",()=>{M()})},M=async()=>{if(y.value||v.value){_.finishPullUp();return}y.value=!0;try{(await n()).data.list.length===0&&(v.value=!0)}catch(l){console.error("加载更多数据失败:",l)}finally{y.value=!1,_.finishPullUp(),_.refresh()}},m=l=>{e("switchChat",l)};return Z(()=>{H(()=>{T()})}),ee(()=>{_&&_.destroy()}),(l,b)=>{const $=Le;return a(),c("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:g},[L(s).length==0?(a(),O(oe,{key:0,size:"140",text:"暂无机器人接待中会话"})):(a(),c("div",De,[(a(!0),c(x,null,I(L(s),f=>(a(),c("div",{key:f.id,class:P(["chat-item",{active:f.id===L(p)}]),onClick:d=>m(f)},[i("div",Oe,[i("img",{src:f.avatar,alt:f.displayName},null,8,je),f.unread>0?(a(),c("span",{key:0,class:P(["dot",{plus:f.unread>9}])},h(f.unread),3)):R("",!0)]),i("div",qe,[i("div",Ae,h(f.displayName),1),i("div",ze,h(f.last_chat_message),1),i("div",He,"来自："+h(f.come_from.app_name),1)])],10,Ne))),128)),y.value?(a(),c("div",Pe,[w($,{size:"small"}),Ue])):R("",!0),v.value?(a(),c("div",Je,"没有更多了")):R("",!0)]))],512)}}},Ee=D(Ve,[["__scopeId","data-v-1ec2dca0"]]),Fe={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(o,{expose:t,emit:e}){const r=o,n=e,s=S(null),p=S({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:r.topTriggerDistance,scrollEndDiff:r.bottomTriggerDistance}),g=S(null),_=l=>{const{scrollTop:b}=l,$=p.value.scrollTop-b;p.value.scrollDirection=$>0?"up":"down",Object.assign(p.value,{scrollTop:b,scrollHeight:l.scrollHeight,clientHeight:l.clientHeight})},y=()=>{const{scrollTop:l,scrollHeight:b,clientHeight:$,scrollStartDiff:f,scrollEndDiff:d,scrollDirection:C}=p.value;n("scroll",{...p.value}),r.isLoading||(Math.abs(l)<=f&&C==="up"&&n("scroll-top",{...p.value}),Math.abs(b-l-$)<=d&&C==="down"&&n("scroll-bottom",{...p.value}))},v=l=>{_(l.target),g.value&&(clearTimeout(g.value),g.value=null),g.value=setTimeout(()=>{y()},100)};function T(){s.value&&(s.value.scrollTop=0)}function M(){s.value&&(s.value.scrollTop=s.value.scrollHeight)}function m(){return s.value&&Object.assign(p.value,{scrollTop:s.value.scrollTop,scrollHeight:s.value.scrollHeight,clientHeight:s.value.clientHeight}),JSON.parse(JSON.stringify(p.value))}return le(()=>r.scrollTop,l=>{s.value&&(s.value.scrollTop=l)}),t({scrollToTop:T,scrollToBottom:M,getState:m}),(l,b)=>(a(),c("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:s,onScroll:v},[K(l.$slots,"default",{},void 0,!0)],544))}},We=D(Fe,[["__scopeId","data-v-3e3a1c2e"]]),ie=o=>(E("data-v-97ee52a0"),o=o(),F(),o),Qe={class:"chat-message-warpper"},Ye={class:"chat-message-content"},Xe={key:0,class:"is-loaded"},Ge={class:"avatar"},Ke=["src","alt"],Ze={class:"message-content"},et={class:"message-info"},tt={class:"nickname"},st=ie(()=>i("i",{class:"gap"},null,-1)),ot={class:"time"},it={class:"message-bubble"},at={key:0,class:"text-content"},nt={key:1},ct={key:1,class:"image-content"},lt=["src"],rt={key:2,class:"menu-content"},dt={class:"menus-label"},ut={key:0,class:"menu-items"},_t=["onClick"],ht={key:3,class:"answer-reference-box"},pt=ie(()=>i("div",{class:"answer-reference-label"},"回答参考",-1)),mt=["onClick"],vt={__name:"chat-message",emits:["openLibrary"],setup(o,{expose:t,emit:e}){const r=e,n=S(null),s=J(),{getChatMessage:p}=s,{messageList:g,messageListScrollTop:_,messageListLoading:y,chatMessageLoadCompleted:v,activeChat:T}=U(s),M=()=>{};function m(C,k,j){let u=Y(C);k.robot_key=T.value.robot_key,k.robot_id=T.value.robot_id,u.forEach(N=>{N.message_id=j.id,N.openid=j.openid,N.robot_key=T.value.robot_key,N.robot_id=T.value.robot_id}),r("openLibrary",u,Y(k))}const l=C=>{const{scrollTop:k}=C;_.value=k},b=async()=>{if(v.value)return;let C=n.value.getState();await p(),H(()=>{let k=n.value.getState();k.scrollDirection=="up"&&(_.value=k.scrollHeight-C.scrollHeight)})},$=async()=>{};return t({scrollToTop:()=>{n.value.scrollToTop()},scrollToBottom:()=>{n.value.scrollToBottom()}}),(C,k)=>{const j=Q;return a(),c("div",Qe,[w(We,{ref_key:"scrollViewRef",ref:n,scrollTop:L(_),"onUpdate:scrollTop":k[0]||(k[0]=u=>te(_)?_.value=u:null),"is-loading":L(y),onScroll:l,onScrollTop:b,onScrollBottom:$},{default:B(()=>[i("div",Ye,[L(v)?(a(),c("div",Xe,"没用更多聊天记录了")):R("",!0),(a(!0),c(x,null,I(L(g),(u,N)=>(a(),c("div",{key:N,class:P(["message-item",u.is_customer==0?"right":""])},[i("div",Ge,[i("img",{src:u.avatar,alt:u.displayName},null,8,Ke)]),i("div",Ze,[i("div",et,[i("span",tt,h(u.displayName),1),st,i("span",ot,h(u.dispayTime),1)]),i("div",it,[u.msg_type==1?(a(),c("div",at,[u.is_customer==0?(a(),O(he,{key:0,content:u.content},null,8,["content"])):(a(),c("div",nt,h(u.content),1))])):u.msg_type==3?(a(),c("div",ct,[i("img",{src:u.content,alt:"image"},null,8,lt)])):u.msg_type==2?(a(),c("div",rt,[i("div",dt,h(u.menu_json.content),1),u.menu_json.question&&u.menu_json.question.length>0?(a(),c("div",ut,[(a(!0),c(x,null,I(u.menu_json.question,(q,V)=>(a(),c("div",{key:V,class:"menu-item",onClick:ae=>M(q)},h(q),9,_t))),128))])):R("",!0)])):R("",!0),u.quote_file&&u.quote_file.length?(a(),c("div",ht,[pt,i("div",null,[(a(!0),c(x,null,I(u.quote_file,(q,V)=>(a(),c("div",{class:"list-item",key:V},[w(j,{name:"attachment"}),i("span",{onClick:ae=>m(u.quote_file,q,u)},h(q.file_name),9,mt)]))),128))])])):R("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},ft=D(vt,[["__scopeId","data-v-97ee52a0"]]),gt={class:"library-info-content"},yt={class:"file-list"},bt=["onClick"],Lt={class:"document-items"},kt={class:"document-item-header"},St={class:"left-box"},Tt={class:"document-title"},$t={key:0,class:"document-title"},Ct={class:"document-size"},wt={class:"document-item-body"},Rt={class:"document-similarity"},Mt={key:0,class:"document-content"},xt={key:1,class:"document-content"},It={class:"document-content"},Bt={class:"fragment-img"},Dt=["src"],Nt={__name:"library-info-alert",setup(o,{expose:t}){const e=re(),r=S(!1),n=S([]),s=S(null),p=()=>{n.value=[],s.value=null},g=(m,l)=>{p(),n.value=m,s.value=l.id,r.value=!0,v(l)},_=m=>{m.id!=s.value&&(s.value=m.id,v(m))},y=S([]),v=m=>{ke({message_id:m.message_id,file_id:m.id,robot_key:m.robot_key,openid:m.openid}).then(l=>{y.value=l.data||[]})},T=()=>{e.push("/library/preview?id="+s.value)},M=()=>{r.value=!1};return t({open:g}),(m,l)=>{const b=Q,$=Se,f=de("viewer");return a(),O($,{class:"library-info-alert",open:r.value,"onUpdate:open":l[0]||(l[0]=d=>r.value=d),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:B(()=>[i("span",{class:"close-btn",onClick:M},[w(L(ve))])]),default:B(()=>[i("div",gt,[i("div",yt,[(a(!0),c(x,null,I(n.value,d=>(a(),c("div",{class:P(["file-item",{active:s.value==d.id}]),key:d.id,onClick:C=>_(d)},h(d.file_name),11,bt))),128))]),i("div",Lt,[(a(!0),c(x,null,I(y.value,d=>(a(),c("div",{class:"document-item",key:d.id},[i("div",kt,[i("div",St,[i("span",Tt,"id："+h(d.id),1),d.title?(a(),c("span",$t,h(d.title),1)):R("",!0),i("span",Ct," 共"+h(d.word_total)+"个字符 ",1)]),i("div",{class:"right-box"},[i("a",{onClick:T},"查看源文档>")])]),i("div",wt,[i("div",Rt,[z(" 相似度： "),w(b,{name:"similarity",style:{"font-size":"16px"}}),z(h(d.similarity),1)]),d.question?(a(),c("div",Mt,"Q："+h(d.question),1)):R("",!0),d.answer?(a(),c("div",xt,"A："+h(d.answer),1)):R("",!0),i("div",It,h(d.content),1),ue((a(),c("div",Bt,[(a(!0),c(x,null,I(d.images,(C,k)=>(a(),c("img",{key:k,src:C,alt:""},null,8,Dt))),128))])),[[f]])])]))),128))])])]),_:1},8,["open"])}}},Ot=D(Nt,[["__scopeId","data-v-3e30a1b1"]]),jt={key:0,class:"chat-box-warpper"},qt={class:"chat-box-header"},At={class:"nickname"},zt={class:"chat-source"},Ht={class:"chat-box-content"},Pt={key:1},Ut={__name:"chat-box",setup(o,{expose:t}){const e=J(),{activeChat:r}=U(e),n=S(null),s=()=>{n.value.scrollToBottom()},p=()=>{n.value.scrollToTop()},g=S(null),_=(y,v)=>{g.value.open(y,v)};return t({scrollToTop:p,scrollToBottom:s}),(y,v)=>(a(),c(x,null,[L(r)?(a(),c("div",jt,[i("div",qt,[i("div",At,h(L(r).name||L(r).nickname),1),i("div",zt," 来自："+h(L(r).come_from.robot_name)+" - "+h(L(r).come_from.app_name),1)]),i("div",Ht,[w(ft,{ref_key:"chatMessageRef",ref:n,onOpenLibrary:_},null,512)])])):(a(),c("div",Pt)),w(Ot,{ref_key:"libraryInfoAlertRef",ref:g},null,512)],64))}},Jt=D(Ut,[["__scopeId","data-v-09d773fd"]]),Vt=o=>(E("data-v-56faf1ca"),o=o(),F(),o),Et={class:"chat-monitor-page"},Ft={class:"page-left"},Wt={class:"app-list-box"},Qt={class:"chat-list-wrapper"},Yt={class:"page-body"},Xt=Vt(()=>i("div",null,[i("p",null,"请在左侧列表先选择会话"),i("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)),Gt={__name:"index",setup(o){const t=se(),e=J(),{init:r,changeRobot:n,switchChat:s,closeIM:p}=e,{robotList:g,selectedRobotId:_,activeChat:y}=U(e),v=S(null),T=()=>{n()},M=async l=>{var b;await s(l),(b=v.value)==null||b.scrollToBottom()},m=()=>{H(()=>{var l;(l=v.value)==null||l.scrollToBottom()})};return Z(async()=>{await r(),H(()=>{var l;(l=v.value)==null||l.scrollToBottom()}),t.on("onAddMessage",m)}),ee(()=>{t.off("onAddMessage",m),p()}),(l,b)=>{const $=$e,f=Te;return a(),c("div",Et,[i("div",Ft,[i("div",Wt,[w(f,{value:L(_),"onUpdate:value":b[0]||(b[0]=d=>te(_)?_.value=d:null),style:{width:"100%"},onChange:T},{default:B(()=>[w($,{value:""},{default:B(()=>[z("全部应用")]),_:1}),(a(!0),c(x,null,I(L(g),d=>(a(),O($,{value:d.id,key:d.id},{default:B(()=>[i("span",null,h(d.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),i("div",Qt,[w(Ee,{onSwitchChat:M})])]),i("div",Yt,[L(y)?(a(),O(Jt,{key:0,ref_key:"chatBoxRef",ref:v},null,512)):(a(),O(oe,{key:1,size:"250"},{default:B(()=>[Xt]),_:1}))])])}}},Ss=D(Gt,[["__scopeId","data-v-56faf1ca"]]);export{Ss as default};
