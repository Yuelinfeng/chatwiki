import{b as be,w as xe,A as ae,r as k,L as _,M as d,V as a,a6 as C,F as L,j as o,Q as i,a1 as W,P as X,X as f,Y as F,a2 as G,E as ue,G as we,u as Y,a9 as me,a3 as pe,a4 as ve,ah as qe,U as le,a0 as $e,$ as Se,a5 as Ie}from"./vue-chunks-Bxyh5WP6.js";import{_ as ne,e as ie,c as fe,B as he,M as te,E as de}from"../../index-CWYf_R7c.js";import{a as Fe,b as Pe,e as Ce,f as ze,s as Le}from"./index-Do3gHCO_.js";import{M as Ne}from"./model-select-BErA6WO-.js";import{F as re,_ as Te}from"./index-Cm_NtOSH.js";import"./index-mQw8zXXP.js";import{I as ge}from"./Input-BW-N7Cx9.js";import{Q as Ee}from"./QuestionCircleOutlined-BggeZNYy.js";import{S as Ue,_ as Oe}from"./index-BLHGs8uC.js";import{_ as je}from"./index-DxeJG8dU.js";import{_ as De}from"./index-DBcoYeqy.js";import{_ as Qe}from"./index-C1M6HpEG.js";import{_ as Be}from"./index-BkDjPG1x.js";import{_ as Re}from"./index-BEK29AQE.js";import{U as Me}from"./index-DZnwQfLH.js";import{_ as Ve,T as Ae}from"./index-CLcBLQ2O.js";import{_ as Je}from"./TextArea-C1_B5Wm2.js";import{B as Ke,_ as Ge}from"./index-qebt7rSa.js";import{S as Xe}from"./index-SLPzh8Tt.js";import{L as We}from"./LeftOutlined-BYYrM9Fu.js";import"./axios-Cm0UX6qg.js";import"./qs-CEiBKtbM.js";import"./crypto-js-C0fK7Mgg.js";import"./dayjs-BgtA0fgD.js";import"./index-DFKCqvOx.js";import"./Trigger-DXFMCREP.js";import"./isPlainObject-Q-ndSLdg.js";import"./responsiveObserve-BtDP6tEg.js";import"./collapseMotion-DDsixTll.js";import"./FormItemContext-CY3sS3S3.js";import"./index-BYiIgJN3.js";import"./Search-C52Nu70G.js";import"./SearchOutlined-gkqcN_Zr.js";import"./inputProps-CuDRpClH.js";import"./Password-BrrLsfMb.js";import"./statusUtils-D2ojHtZY.js";import"./slide-BHEoaamw.js";import"./index-C_rHdEod.js";import"./isMobile-D_4OiXLP.js";import"./CheckOutlined-DAabT47N.js";import"./DownOutlined-BawL_eGx.js";import"./move-DtLl1qq4.js";import"./UpOutlined-BsYeG87t.js";import"./colors-CmI3I2v0.js";import"./index-DV-9vSKv.js";import"./index-D70JqhWj.js";import"./partition-Dd7XR8Em.js";import"./useRefs-DgEUwJAf.js";import"./index-Cyz9zV9F.js";import"./shallowequal-Do1xa-L4.js";import"./Dropdown-BiMe9RPS.js";import"./pick-D5pnwb9s.js";import"./PlusOutlined-Cu0dwBBw.js";import"./dropdown-BMPfc6hB.js";import"./RightOutlined-BOQt46xG.js";const v=S=>(pe("data-v-c191a923"),S=S(),ve(),S),Ye={class:"segmentation-setting"},He={class:"setting-items"},Ze={class:"setting-item intelligent-setting active"},et={class:"setting-item-body"},tt=v(()=>a("div",{class:"sub-setting-item-name"},"文件切分",-1)),at={key:0,class:"custom-setting-form excel-qa-form"},nt={class:"form-item"},ot=v(()=>a("div",{class:"form-item-label"},"问题所在列：",-1)),st={class:"form-item-body"},lt={class:"form-item"},it=v(()=>a("div",{class:"form-item-label"},"答案所在列：",-1)),rt={class:"form-item-body"},_t=v(()=>a("div",{class:"sub-setting-item-name"},"索引方式",-1)),ct={class:"indexing-methods-box"},dt={class:"list-title-block"},ut=v(()=>a("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复 ",-1)),mt={class:"list-title-block"},pt=v(()=>a("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复 ",-1)),vt={key:1,class:"custom-setting-form"},ft={class:"form-item"},ht=v(()=>a("div",{class:"form-item-label"},"问题开始标识符：",-1)),gt={class:"form-item-body"},kt={class:"form-item"},yt=v(()=>a("div",{class:"form-item-label"},"答案开始标识符：",-1)),bt={class:"form-item-body"},xt=v(()=>a("div",{class:"sub-setting-item-name"},"索引方式",-1)),wt={class:"indexing-methods-box"},qt={class:"list-title-block"},$t=v(()=>a("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题和答案一起对比相似度，根据相似度高的问题和答案回复 ",-1)),St={class:"list-title-block"},It=v(()=>a("div",{class:"list-content"}," 回答用户提问时，将用户提问与导入的问题一起对比相似度，再根据相似度高的问题和对应的答案来回复 ",-1)),Ft={key:0,class:"custom-setting-form subsection-form"},Pt={class:"form-item"},Ct=v(()=>a("div",{class:"form-item-label"},"分段方式：",-1)),zt={class:"form-item-body"},Lt={class:"select-card-box"},Nt={class:"card-title"},Tt=v(()=>a("div",{class:"card-desc"}," 基于文章中句号、空行，或者自定义符号进行分段，不会消耗模型token ",-1)),Et={class:"card-title"},Ut=v(()=>a("div",{class:"card-desc"}," 将文章拆分成句子后，通过语句向量相似度进行分段，会消耗模型token ",-1)),Ot={class:"form-item",style:{"margin-bottom":"18px"}},jt=v(()=>a("div",{class:"form-item-label"},"分段标识符：",-1)),Dt={class:"form-item-body"},Qt={class:"form-item"},Bt=v(()=>a("div",{class:"form-item-label"},"分段最大长度：",-1)),Rt={class:"form-item-body"},Mt=v(()=>a("span",{class:"unit-text"},"字符",-1)),Vt={class:"form-item"},At=v(()=>a("div",{class:"form-item-label not-required"},"分段重叠长度：",-1)),Jt={class:"form-item-body"},Kt=v(()=>a("span",{class:"unit-text"},"字符",-1)),Gt={class:"form-item",style:{"margin-bottom":"16px"}},Xt=v(()=>a("div",{class:"form-item-label"},"嵌入模型：",-1)),Wt={class:"form-item-body"},Yt={class:"form-item",style:{"margin-bottom":"16px"}},Ht={class:"form-item-label"},Zt={class:"form-item-body"},ea={class:"form-item"},ta=v(()=>a("div",{class:"form-item-label"},"分段最大长度：",-1)),aa={class:"form-item-body"},na=v(()=>a("span",{class:"unit-text"},"字符",-1)),oa={class:"form-item"},sa=v(()=>a("div",{class:"form-item-label not-required"},"分段重叠长度：",-1)),la={class:"form-item-body"},ia=v(()=>a("span",{class:"unit-text"},"字符",-1)),ra={class:"btn-box-block"},_a={__name:"segmentation-setting",props:{mode:{type:Number,default:0},excellQaLists:{type:Array,default:()=>[]},libFileInfo:{type:Object,default:()=>{}},library_type:{default:0}},emits:["change","validate"],setup(S,{expose:O,emit:z}){const h=re.useForm,w=z,p=S;be(()=>p.libFileInfo.doc_type=="1"&&(p.libFileInfo.file_ext=="docx"||p.libFileInfo.file_ext=="html")),xe(p,r=>{let t=r.libFileInfo,m=t.separators_no?t.separators_no.split(","):[11,12];e.separators_no=m.map($=>+$),e.chunk_size=+t.chunk_size||512,e.chunk_overlap=+t.chunk_overlap||50,e.question_lable=t.question_lable,e.answer_lable=t.answer_lable,e.question_column=t.question_column||void 0,e.answer_column=t.answer_column||void 0,e.qa_index_type=+t.qa_index_type,e.enable_extract_image=t.enable_extract_image=="true",e.chunk_type=+t.chunk_type,e.semantic_chunk_size=+t.semantic_chunk_size||512,e.semantic_chunk_overlap=+t.semantic_chunk_overlap||50,e.semantic_chunk_threshold=+t.semantic_chunk_threshold||90,e.semantic_chunk_use_model=t.semantic_chunk_use_model||"",e.semantic_chunk_model_config_id=t.semantic_chunk_model_config_id>0?t.semantic_chunk_model_config_id:"",t.chunk_type==0&&(m=t.normal_chunk_default_separators_no?t.normal_chunk_default_separators_no.split(","):[11,12],e.separators_no=m.map($=>+$),e.chunk_size=+t.normal_chunk_default_chunk_size||512,e.chunk_overlap=+t.normal_chunk_default_chunk_overlap||50,e.chunk_type=+t.default_chunk_type,e.semantic_chunk_size=+t.semantic_chunk_default_chunk_size||512,e.semantic_chunk_overlap=+t.semantic_chunk_default_chunk_overlap||50,e.semantic_chunk_threshold=+t.semantic_chunk_default_threshold||90,setTimeout(()=>{e.semantic_chunk_use_model=t.default_use_model,e.semantic_chunk_model_config_id=t.default_model_config_id>0?t.default_model_config_id:""},100)),e.is_qa_doc=p.library_type==2?1:0});const e=ae({separators_no:[],chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",question_column:void 0,answer_column:void 0,qa_index_type:1,enable_extract_image:!0,chunk_type:1,semantic_chunk_size:512,semantic_chunk_overlap:50,semantic_chunk_threshold:90,semantic_chunk_use_model:"",semantic_chunk_model_config_id:""});let l={};setTimeout(()=>{l=JSON.parse(JSON.stringify(e))},500);const j=k([]),D=r=>{j.value=r},V=()=>{Object.assign(e,l)},N=ae({question_lable:[{message:"请输入问题开始标识符",validator:async(r,t)=>e.is_qa_doc==1&&p.mode==0?t?Promise.resolve():Promise.reject("请输入问题开始标识符"):Promise.resolve()}],semantic_chunk_model_config_id:[{message:"请选择嵌入模型",validator:async(r,t)=>e.is_qa_doc==0&&e.chunk_type==2?t?Promise.resolve():Promise.reject("请选择嵌入模型"):Promise.resolve()}],answer_lable:[{message:"请输入答案开始标识符",validator:async(r,t)=>e.is_qa_doc==1&&p.mode==0?t?Promise.resolve():Promise.reject("请输入答案开始标识符"):Promise.resolve()}],separators_no:[{message:"请选择分段标识符",validator:async(r,t)=>p.mode!=1&&e.is_qa_doc==0&&t.length==0&&e.chunk_type==1?Promise.reject("请选择分段标识符"):Promise.resolve()}],chunk_size:[{validator:async(r,t)=>{if(p.mode!=1&&e.chunk_type==1)if(t){if(t>2e3)return Promise.reject("最大分段长最大值不得超过2000")}else return Promise.reject("请输入分段最大长度");return Promise.resolve()}}],chunk_overlap:[{validator:async(r,t)=>p.mode!=1&&e.chunk_type==1&&t>parseInt(e.chunk_size/2)?Promise.reject("分段重叠长度最大不得超过最大分段长度的50%"):Promise.resolve()}],question_column:[{message:"请选择问题所在列",validator:async(r,t)=>p.mode==1&&e.is_qa_doc==1?t?Promise.resolve():Promise.reject("请选择问题所在列"):Promise.resolve()}],answer_column:[{message:"请选择答案所在列",validator:async(r,t)=>p.mode==1&&e.is_qa_doc==1?t?Promise.resolve():Promise.reject("请选择答案所在列"):Promise.resolve()}]}),{resetFields:T,validate:K,validateInfos:A}=h(e,N),y=k(!1),c=()=>{y.value=!0,P()},P=(r=!0)=>{let t=me(e);K().then(()=>{w("change",{...t}),w("validate","")}).catch(m=>{const{errorFields:$}=m;if($.length>0){r&&$[0].name,ie.error($[0].errors[0]),w("validate",$[0].errors[0]),y.value=!1;return}w("validate",""),w("change",{...t})})};let q=null;const u=()=>{q&&(clearTimeout(q),q=null),q=setTimeout(()=>{P()},500)},Q=k([]);(()=>{Fe().then(r=>{Q.value=r.data||[]})})();const E=r=>{r!=e.qa_index_type&&(e.qa_index_type=r,P())};return O({formState:e,reLoading:y}),(r,t)=>{const m=Ue,$=Oe,b=fe,H=ge,I=je,oe=Be,R=De,Z=Qe,ee=he;return _(),d("div",Ye,[a("div",He,[a("div",Ze,[a("div",et,[C("",!0),e.is_qa_doc==1?(_(),d(L,{key:1},[tt,p.mode==1?(_(),d("div",at,[a("div",nt,[ot,a("div",st,[o($,{value:e.question_column,"onUpdate:value":t[2]||(t[2]=s=>e.question_column=s),onChange:u,placeholder:"请选择列名",style:{width:"100%"}},{default:i(()=>[(_(!0),d(L,null,W(p.excellQaLists,s=>(_(),X(m,{value:s.value,key:s.value},{default:i(()=>[f(F(s.lable),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),a("div",lt,[it,a("div",rt,[o($,{value:e.answer_column,"onUpdate:value":t[3]||(t[3]=s=>e.answer_column=s),onChange:u,placeholder:"请选择答案所在列",style:{width:"100%"}},{default:i(()=>[(_(!0),d(L,null,W(p.excellQaLists,s=>(_(),X(m,{value:s.value,key:s.value},{default:i(()=>[f(F(s.lable),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),_t,a("div",ct,[a("div",{class:G(["list-item",{active:e.qa_index_type==1}]),onClick:t[4]||(t[4]=s=>E(1))},[o(b,{class:"check-icon",name:"check-arrow-filled"}),a("div",dt,[o(b,{name:"file-search"}),f(" 问题与答案一起生成索引 ")]),ut],2),a("div",{class:G(["list-item",{active:e.qa_index_type==2}]),onClick:t[5]||(t[5]=s=>E(2))},[o(b,{class:"check-icon",name:"check-arrow-filled"}),a("div",mt,[o(b,{name:"comment-search"}),f(" 仅对问题生成索引 ")]),pt],2)])])):(_(),d("div",vt,[o(I,{gap:16},{default:i(()=>[a("div",ft,[ht,a("div",gt,[o(H,{placeholder:"请输入标识符",value:e.question_lable,"onUpdate:value":t[6]||(t[6]=s=>e.question_lable=s),onChange:u},null,8,["value"])])]),a("div",kt,[yt,a("div",bt,[o(H,{placeholder:"请输入标识符",value:e.answer_lable,"onUpdate:value":t[7]||(t[7]=s=>e.answer_lable=s),onChange:u},null,8,["value"])])])]),_:1}),xt,a("div",wt,[a("div",{class:G(["list-item",{active:e.qa_index_type==1}]),onClick:t[8]||(t[8]=s=>E(1))},[o(b,{class:"check-icon",name:"check-arrow-filled"}),a("div",qt,[o(b,{name:"file-search"}),f(" 问题与答案一起生成索引 ")]),$t],2),a("div",{class:G(["list-item",{active:e.qa_index_type==2}]),onClick:t[9]||(t[9]=s=>E(2))},[o(b,{class:"check-icon",name:"check-arrow-filled"}),a("div",St,[o(b,{name:"comment-search"}),f(" 仅对问题生成索引 ")]),It],2)])]))],64)):(_(),d(L,{key:2},[p.mode!=1?(_(),d("div",Ft,[a("div",Pt,[Ct,a("div",zt,[a("div",Lt,[a("div",{class:G(["select-card-item",{active:e.chunk_type==1}]),onClick:t[10]||(t[10]=s=>e.chunk_type=1)},[o(b,{class:"check-arrow",name:"check-arrow-filled"}),a("div",Nt,[o(b,{name:"ordinary-segmentation",class:"title-icon"}),f(" 普通分段 ")]),Tt],2),a("div",{class:G(["select-card-item",{active:e.chunk_type==2}]),onClick:t[11]||(t[11]=s=>e.chunk_type=2)},[o(b,{class:"check-arrow",name:"check-arrow-filled"}),a("div",Et,[o(b,{name:"semantic-segmentation",class:"title-icon"}),f(" 语义分段 ")]),Ut],2)]),e.chunk_type==2?(_(),X(oe,{key:0,style:{"margin-top":"12px"},message:"提示：语义分段更适合没有排版过的文章，即没有明显换行符号的文本，否则更推荐使用普通分段"})):C("",!0)])]),e.chunk_type==1?(_(),d(L,{key:0},[a("div",Ot,[jt,a("div",Dt,[o($,{placeholder:"请选择",style:{width:"100%"},mode:"multiple",value:e.separators_no,"onUpdate:value":t[12]||(t[12]=s=>e.separators_no=s)},{default:i(()=>[(_(!0),d(L,null,W(Q.value,s=>(_(),X(m,{value:s.no,key:s.no},{default:i(()=>[f(F(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),o(I,{gap:16},{default:i(()=>[a("div",Qt,[Bt,a("div",Rt,[o(I,{align:"center",gap:8},{default:i(()=>[o(R,{style:{flex:"1"},value:e.chunk_size,"onUpdate:value":t[13]||(t[13]=s=>e.chunk_size=s),placeholder:"分段最大长度",min:200,max:2e3,precision:0,formatter:s=>parseInt(s),parser:s=>parseInt(s)},null,8,["value","formatter","parser"]),Mt]),_:1})])]),a("div",Vt,[At,a("div",Jt,[o(I,{align:"center",gap:8},{default:i(()=>[o(R,{style:{flex:"1"},value:e.chunk_overlap,"onUpdate:value":t[14]||(t[14]=s=>e.chunk_overlap=s),placeholder:"分段重叠长度",min:0,formatter:s=>parseInt(s),parser:s=>parseInt(s)},null,8,["value","formatter","parser"]),Kt]),_:1})])])]),_:1})],64)):C("",!0),ue(a("div",null,[a("div",Gt,[Xt,a("div",Wt,[o(Ne,{modelType:"TEXT EMBEDDING",modeName:e.semantic_chunk_use_model,"onUpdate:modeName":t[15]||(t[15]=s=>e.semantic_chunk_use_model=s),modeId:e.semantic_chunk_model_config_id,"onUpdate:modeId":t[16]||(t[16]=s=>e.semantic_chunk_model_config_id=s),style:{width:"100%"},onLoaded:D},null,8,["modeName","modeId"])])]),a("div",Yt,[a("div",Ht,[f(" 分段阈值 "),o(Z,null,{title:i(()=>[f("用于控制分段拆分的标准，数值0~100,数值越大，分段越少，数值越小，分段越多。")]),default:i(()=>[o(Y(Ee),{style:{cursor:"pointer","margin-left":"2px"}})]),_:1}),f("： ")]),a("div",Zt,[o(R,{style:{width:"100%"},value:e.semantic_chunk_threshold,"onUpdate:value":t[17]||(t[17]=s=>e.semantic_chunk_threshold=s),placeholder:"请输入分段阈值",precision:0,min:0,max:100},null,8,["value"])])]),o(I,{gap:16},{default:i(()=>[a("div",ea,[ta,a("div",aa,[o(I,{align:"center",gap:8},{default:i(()=>[o(R,{style:{flex:"1"},value:e.semantic_chunk_size,"onUpdate:value":t[18]||(t[18]=s=>e.semantic_chunk_size=s),placeholder:"分段最大长度",min:200,max:2e3,precision:0,formatter:s=>parseInt(s),parser:s=>parseInt(s)},null,8,["value","formatter","parser"]),na]),_:1})])]),a("div",oa,[sa,a("div",la,[o(I,{align:"center",gap:8},{default:i(()=>[o(R,{style:{flex:"1"},value:e.semantic_chunk_overlap,"onUpdate:value":t[19]||(t[19]=s=>e.semantic_chunk_overlap=s),placeholder:"分段重叠长度",min:0,formatter:s=>parseInt(s),parser:s=>parseInt(s)},null,8,["value","formatter","parser"]),ia]),_:1})])])]),_:1})],512),[[we,e.chunk_type==2]]),a("div",ra,[o(ee,{onClick:V,style:{flex:"1"}},{default:i(()=>[f("重置")]),_:1}),o(ee,{onClick:c,loading:y.value,style:{flex:"1"},type:"primary",ghost:""},{default:i(()=>[f("重新分段")]),_:1},8,["loading"])])])):C("",!0)],64))])])])])}}},ca=ne(_a,[["__scopeId","data-v-c191a923"]]),da={class:"document-fragment"},ua={class:"fragment-header"},ma={class:"fragment-info"},pa={class:"fragment-number"},va={key:0,class:"fragment-title"},fa={class:"fragment-content-lenght"},ha={class:"fragment-action"},ga={class:"fragment-content"},ka={key:0,class:"fragment-content"},ya={key:1,class:"fragment-content"},ba={class:"fragment-img"},xa=["src"],wa={__name:"document-fragment",props:{number:{type:[Number,String]},total:{type:[Number,String]},title:{type:[Number,String]},content:{type:[Number,String]},question:{type:[Number,String]},answer:{type:[Number,String]},images:{type:[Array,String]}},emits:["edit","delete"],setup(S,{emit:O}){const z=O,h=S,w=()=>{z("edit")},p=()=>{z("delete")};return(e,l)=>{const j=Re,D=qe("viewer");return _(),d("div",da,[a("div",ua,[a("div",ma,[a("span",pa,"#"+F(h.number),1),h.title?(_(),d("span",va,F(h.title),1)):C("",!0),a("span",fa,"共"+F(h.total)+"个字符",1)]),a("div",ha,[a("a",{onClick:w},"编辑"),o(j,{type:"vertical"}),a("a",{onClick:p},"删除")])]),a("div",ga,F(h.content),1),h.question?(_(),d("div",ka,"Q："+F(h.question),1)):C("",!0),h.answer?(_(),d("div",ya,"A："+F(h.answer),1)):C("",!0),ue((_(),d("div",ba,[(_(!0),d(L,null,W(h.images,(V,N)=>(_(),d("img",{key:N,src:V,alt:""},null,8,xa))),128))])),[[D]])])}}},qa=ne(wa,[["__scopeId","data-v-3a2afee8"]]),$a={class:"upload-box-wrapper"},Sa={key:0},Ia={__name:"edit-fragment-alert",emits:["ok"],setup(S,{expose:O,emit:z}){const h=z,w=k("1"),p=re.useForm,e=k(!1),l=ae({title:"",content:"",question:"",answer:"",images:[]}),j=ae({content:[{message:"请输入分段内容",validator:async(y,c)=>T.value||c?Promise.resolve():Promise.reject("请输入分段内容")}],question:[{message:"请输入分段问题",validator:async(y,c)=>T.value?c?Promise.resolve():Promise.reject("请输入分段问题"):Promise.resolve()}],answer:[{message:"请输入分段答案",validator:async(y,c)=>T.value?c?Promise.resolve():Promise.reject("请输入分段答案"):Promise.resolve()}]}),{resetFields:D,validate:V,validateInfos:N}=p(l,j),T=k(!1),K=({title:y,content:c,question:P,answer:q,images:u})=>{l.title=y,l.content=c,l.question=P,l.answer=q,l.images=u||[],T.value=P!="",e.value=!0},A=()=>{V().then(()=>{e.value=!1,h("ok",me(l))})};return O({open:K}),(y,c)=>{const P=ge,q=Te,u=Je,Q=fe,B=Ve,E=Ae,r=re,t=te;return _(),d("div",null,[o(t,{open:e.value,"onUpdate:open":c[6]||(c[6]=m=>e.value=m),title:"编辑分段",onOk:A,width:"746px"},{default:i(()=>[o(r,{layout:"vertical"},{default:i(()=>[o(q,{label:"分段标题："},{default:i(()=>[o(P,{type:"text",placeholder:"请输入分段标题",value:l.title,"onUpdate:value":c[0]||(c[0]=m=>l.title=m)},null,8,["value"])]),_:1}),T.value?(_(),d(L,{key:0},[o(q,le({label:"分段问题："},Y(N).question),{default:i(()=>[o(u,{placeholder:"请输入分段问题",value:l.question,"onUpdate:value":c[1]||(c[1]=m=>l.question=m),style:{height:"100px"}},null,8,["value"])]),_:1},16),o(q,le({label:"分段答案："},Y(N).answer),{default:i(()=>[o(u,{placeholder:"请输入分段答案",value:l.answer,"onUpdate:value":c[2]||(c[2]=m=>l.answer=m),style:{height:"140px"}},null,8,["value"])]),_:1},16)],64)):(_(),X(q,le({key:1,label:"分段内容："},Y(N).content),{default:i(()=>[o(u,{placeholder:"请输入分段内容",value:l.content,"onUpdate:value":c[3]||(c[3]=m=>l.content=m),style:{height:"150px"}},null,8,["value"])]),_:1},16)),o(q,{label:"附件"},{default:i(()=>[a("div",$a,[o(E,{activeKey:w.value,"onUpdate:activeKey":c[4]||(c[4]=m=>w.value=m),size:"small"},{default:i(()=>[o(B,{key:"1"},{tab:i(()=>[a("span",null,[o(Q,{name:"img-icon",style:{"font-size":"14px",color:"#2475fc"}}),f(" 图片 "),l.images.length?(_(),d("span",Sa,"("+F(l.images.length)+")",1)):C("",!0)])]),_:1})]),_:1},8,["activeKey"]),o(Me,{value:l.images,"onUpdate:value":c[5]||(c[5]=m=>l.images=m)},null,8,["value"])])]),_:1})]),_:1})]),_:1},8,["open"])])}}},Fa=ne(Ia,[["__scopeId","data-v-6df5439f"]]),ke=S=>(pe("data-v-3691e129"),S=S(),ve(),S),Pa={key:0,class:"loading-wrap"},Ca={class:"document-segmentation"},za={class:"breadcrumb-block"},La={class:"page-title"},Na=ke(()=>a("span",{class:"title"},"文档分段与清洗",-1)),Ta={key:0,class:"page-title-right",style:{"margin-left":"auto"}},Ea={class:"page-container"},Ua={class:"page-left"},Oa={class:"page-right"},ja={class:"document-fragment-preview"},Da={class:"preview-header"},Qa=ke(()=>a("span",{class:"label-text"},"分段预览",-1)),Ba={class:"fragment-number"},Ra={key:0,class:"footer-btn-box"},Ma={__name:"document-segmentation",setup(S){const O=$e(),z=Se(),{document_id:h}=O.query,w=k(!0),p=k(1);let e=!1,l={id:h,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0},j=!1;const D=k(null),V=n=>{typeof n.separators_no=="object"&&(n.separators_no=n.separators_no.join(",")),j=!0,l={...l,...n},e?te.confirm({title:"提醒",icon:o(de),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){e=!1,B()},onCancel(){}}):(e=!1,B())};let N=60*10,T=0,K=null;const A=k({}),y=k(0),c=()=>{w.value||(w.value=!0),Pe({id:h}).then(async n=>{const{status:g}=n.data;if(y.value=n.data.library_type,A.value=n.data,l={...l,separators_no:n.data.separators_no||"11,12",chunk_size:+n.data.chunk_size||512,chunk_overlap:+n.data.chunk_overlap||50,is_qa_doc:y.value==2?1:0,question_lable:n.data.question_lable,answer_lable:n.data.answer_lable,question_column:n.data.question_column,answer_column:n.data.answer_column,enable_extract_image:n.data.enable_extract_image=="true",qa_index_type:+n.data.qa_index_type,chunk_type:+n.data.chunk_type,semantic_chunk_size:+n.data.semantic_chunk_size||512,semantic_chunk_overlap:+n.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+n.data.semantic_chunk_threshold||90,semantic_chunk_use_model:n.data.semantic_chunk_use_model||"",semantic_chunk_model_config_id:n.data.semantic_chunk_model_config_id>0?n.data.semantic_chunk_model_config_id:""},n.data.chunk_type==0&&(l={...l,separators_no:n.data.normal_chunk_default_separators_no,chunk_size:n.data.normal_chunk_default_chunk_size,chunk_overlap:n.data.normal_chunk_default_chunk_overlap,chunk_type:+n.data.default_chunk_type,semantic_chunk_size:+n.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+n.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+n.data.semantic_chunk_default_threshold,semantic_chunk_use_model:n.data.default_use_model||"",semantic_chunk_model_config_id:n.data.default_model_config_id>0?n.data.default_model_config_id:""}),g==0){if(T++,T>N){te.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{c()},1e3)}else g==4||g==2?(w.value=!1,p.value=parseInt(n.data.is_table_file),K=n.data.library_id,y.value==2?(l.question_lable||l.question_column)&&B():B()):z.replace("/library/details?id="+n.data.library_id);n.data.is_table_file==1&&q()})};c();const P=k([]),q=()=>{Ce({id:h}).then(n=>{let g=[];for(let x in n.data)g.push({lable:n.data[x],value:x});P.value=g})},u=k([]),Q=k(0),B=()=>ze({...l,semantic_chunk_model_config_id:l.semantic_chunk_model_config_id?+l.semantic_chunk_model_config_id:0}).then(n=>{u.value=n.data.list||[],Q.value=n.data.list.length||0}).finally(()=>{D.value.reLoading=!1}),E=k(null);let r=null;const t=({title:n,content:g,question:x,answer:M,images:J},se)=>{r=se,E.value.open({title:n,content:g,question:x,answer:M,images:J})},m=({title:n,content:g,question:x,answer:M,images:J})=>{(u.value[r].title!=n||u.value[r].content!=g||u.value[r].question!=x||u.value[r].answer!=M)&&(e=!0),u.value[r].title=n,u.value[r].content=g,u.value[r].question=x,u.value[r].answer=M,u.value[r].images=J,u.value[r].word_total=M.length+x.length+g.length},$=n=>{te.confirm({title:"提醒",icon:o(de),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){e=!0,u.value.splice(n,1)},onCancel(){}})},b=k(""),H=n=>{b.value=n},I=k(!1),oe=()=>{let n=D.value.formState;n=JSON.parse(JSON.stringify(n)),typeof n.separators_no=="object"&&(n.separators_no=n.separators_no.join(",")),l={...l,...n}},R=async()=>{if(oe(),await B(),b.value)return ie.error(b.value);let n={...l,semantic_chunk_model_config_id:l.semantic_chunk_model_config_id?+l.semantic_chunk_model_config_id:0,is_table_file:p.value};delete n.id;let g={id:h,word_total:Q.value,split_params:JSON.stringify(n),list:JSON.stringify(u.value)};n.is_qa_doc==1&&(g.qa_index_type=n.qa_index_type),I.value=!0,Le(g).then(()=>{if(ie.success("保存成功"),O.query.source=="preview"&&!j){s();return}z.replace("/library/details?id="+K)}).finally(()=>{I.value=!1}).catch(x=>{x.data&&x.data.index&&ee(x.data.index)})},Z=k(null),ee=n=>{n=n-1;let g=Z.value.querySelectorAll(".fragment-item");g.length>=n&&g[n].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},s=()=>{z.back()};return(n,g)=>{const x=Xe,M=Ie("router-link"),J=Ge,se=Ke,_e=he;return _(),d(L,null,[w.value?(_(),d("div",Pa,[o(x)])):C("",!0),a("div",Ca,[a("div",za,[o(se,null,{default:i(()=>[o(J,null,{default:i(()=>[o(M,{to:"/library/list"},{default:i(()=>[f(" 知识库管理 ")]),_:1})]),_:1}),o(J,null,{default:i(()=>[o(M,{to:{path:"/library/details/knowledge-document",query:{id:A.value.library_id}}},{default:i(()=>[f(F(A.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),o(J,null,{default:i(()=>[f("分段设置")]),_:1})]),_:1})]),a("div",La,[o(Y(We),{onClick:s}),Na,y.value==0?(_(),d("div",Ta,[o(_e,{type:"primary",loading:I.value,onClick:R},{default:i(()=>[f("保存")]),_:1},8,["loading"])])):C("",!0)]),a("div",Ea,[a("div",Ua,[o(ca,{excellQaLists:P.value,libFileInfo:A.value,library_type:y.value,mode:p.value,ref_key:"segmentationSettingRef",ref:D,onChange:V,onValidate:H},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),a("div",Oa,[a("div",ja,[a("div",Da,[Qa,a("span",Ba,"共"+F(Q.value)+"个分段",1)]),a("div",{class:"preview-box",ref_key:"previewBoxRef",ref:Z},[(_(!0),d(L,null,W(u.value,(U,ce)=>(_(),d("div",{class:"fragment-item",key:U.number},[o(qa,{number:U.number,title:U.title,content:U.content,total:U.word_total,question:U.question,answer:U.answer,images:U.images,onDelete:ye=>$(ce),onEdit:ye=>t(U,ce)},null,8,["number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),y.value==1?(_(),d("div",Ra,[o(_e,{type:"primary",loading:I.value,onClick:R},{default:i(()=>[f("保存")]),_:1},8,["loading"])])):C("",!0),o(Fa,{ref_key:"editFragmentAlertRef",ref:E,onOk:m},null,512)])],64)}}},Jn=ne(Ma,[["__scopeId","data-v-3691e129"]]);export{Jn as default};
