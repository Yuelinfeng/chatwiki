(function(r){typeof define=="function"&&define.amd?define(r):r()})(function(){"use strict";var g=Object.defineProperty;var u=(r,o,l)=>o in r?g(r,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[o]=l;var e=(r,o,l)=>(u(r,typeof o!="symbol"?o+"":o,l),l);function r(n){if(!n)return"";const t=[];for(let i in n)if(n.hasOwnProperty(i)){let a=n[i];(Array.isArray(a)||typeof a=="object"&&a!==null)&&(a=JSON.stringify(a)),a!==void 0&&t.push(encodeURIComponent(i)+"="+encodeURIComponent(a))}return t.join("&")}function o(){var n=document.createElement("link");n.type="text/css",n.rel="stylesheet",n.href="./style.css",document.getElementsByTagName("head")[0].appendChild(n)}class l{constructor(t){e(this,"iframe",null);e(this,"iframeSrc",null);e(this,"onClose",null);e(this,"onInit",null);e(this,"expectedOrigin",["localhost","127.0.0.1"]);e(this,"config",{});t&&(this.config=t,this.iframeSrc=this.config.iframeSrc,console.log(this.iframeSrc),this.init())}init(){console.log(this.iframeSrc),this.iframeSrc&&this.insertAiChat(),window.addEventListener("message",this.handleMessage.bind(this),!1)}handleMessage(t){if(!t.origin)return;const i=new URL(t.origin);if(!this.expectedOrigin.some(h=>i.hostname===h))return;let s=t.data;console.log("Received message from parent:",s),s&&(s.action==="closeChat"&&this.close(),s.action==="init"&&this.onInit(s.data))}postMessage(t,i){if(i)try{i=JSON.parse(JSON.stringify(i))}catch(a){console.error("Failed to stringify data:",a);return}if(this.iframe.contentWindow&&typeof this.iframe.contentWindow.postMessage=="function")try{this.iframe.contentWindow.postMessage({action:t,data:i},"*")}catch(a){console.error("Failed to post message:",a)}else console.warn("frame.contentWindow is not available or postMessage is not supported.")}insertAiChat(){if(document.getElementById("zm_chat-wiki-iframe"))return;const t=r(this.config.params);this.iframe=document.createElement("iframe"),this.iframe.id="zm_chat-wiki-iframe",this.iframe.src=this.iframeSrc+"?"+t,this.iframe.style.display="none",document.body.appendChild(this.iframe)}removeAiChat(){const t=document.getElementById("zm_chat-wiki-iframe");t&&(document.body.removeChild(t),this.iframe=null)}open(){this.iframe.style.display="block",this.postMessage("openWindow",{})}close(){this.onClose&&(this.iframe.style.display="none",this.onClose())}}class c{constructor(t){e(this,"clickHandler",null);e(this,"avatarEl",null);e(this,"avatarSrc","");e(this,"left",0);e(this,"top",0);e(this,"width",50);e(this,"height",50);e(this,"initialX",0);e(this,"initialY",0);e(this,"initialMouseX",0);e(this,"initialMouseY",0);e(this,"dragging",!1);e(this,"handleDrag",t=>{this.dragging=!0;const i=t.clientX-this.initialMouseX,a=t.clientY-this.initialMouseY,s=window.innerWidth,h=window.innerHeight;this.left=Math.max(0,Math.min(i,s-this.width)),this.top=Math.max(0,Math.min(a,h-this.height)),this.avatarEl.style.left=this.left+"px",this.avatarEl.style.top=this.top+"px"});e(this,"handleDragEnd",()=>{const t=Math.abs(this.initialX-this.left),i=Math.abs(this.initialY-this.top);t<=3&&i<=3&&this.handleClick(),this.dragging=!1,document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.handleDragEnd)});t&&(this.avatarSrc=t.avatarSrc)}init(t){console.log(t),this.avatarSrc=t.sdkFloatAvatar,this.getInitialPosition(),this.insertAvatar()}getInitialPosition(){const t=window.innerWidth,i=window.innerHeight;this.left=t-this.width-50,this.top=i-this.height-50}enableDrag(){this.avatarEl.addEventListener("mousedown",t=>{this.initialX=this.left,this.initialY=this.top,this.initialMouseX=t.clientX-this.avatarEl.getBoundingClientRect().left,this.initialMouseY=t.clientY-this.avatarEl.getBoundingClientRect().top,document.addEventListener("mousemove",this.handleDrag),document.addEventListener("mouseup",this.handleDragEnd),t.preventDefault()})}insertAvatar(){document.getElementById("zm_chat-wiki-avatar")||(this.avatarEl=document.createElement("img"),this.avatarEl.style.display="block",this.avatarEl.style.top=this.top+"px",this.avatarEl.style.left=this.left+"px",this.avatarEl.style.width=this.width+"px",this.avatarEl.style.height=this.height+"px",this.avatarEl.src=this.avatarSrc,this.avatarEl.id="zm_chat-wiki-avatar",this.enableDrag(),document.body.appendChild(this.avatarEl))}handleClick(t){this.clickHandler&&this.clickHandler()}removeAvatar(){this.avatarEl&&document.body.removeChild(this.avatarEl)}show(){this.avatarEl.style.display="block"}hide(){this.avatarEl.style.display="none"}}function d(n){let t={iframeSrc:"https://zhima_chat_ai.applnk.cn/chat-ai-pc/#/chat",remote:"",params:n};const i=document.getElementById("ai_chat_js");if(i){let h=i.getAttribute("data-json"),m=new URL(i.src).origin;t.iframeSrc=m+"/#/chat";try{t.params=JSON.parse(h),t.params.remote=i.getAttribute("data-remote")}catch(f){console.error("Failed to stringify data:",f);return}}console.log(t);const a=new l(t),s=new c(t);a.onInit=h=>{s.init(h)},a.onClose=()=>{s.show()},s.clickHandler=()=>{a.open(),s.hide()}}o(),window.AiChatSDK=d()});
